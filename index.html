<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <!-- CamanJS for color adjustment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- glfx.js for advanced image warping -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.8/fx.js"></script>
    <style>
        /* ... (CSS giữ nguyên) ... */
        
        /* WARP MODAL */
        .warp-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            padding: 25px;
            border-radius: 15px;
            z-index: 1001;
            width: 500px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
        }

        .warp-modal.active {
            display: block;
        }

        .warp-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .warp-control {
            background: rgba(60, 60, 100, 0.8);
            padding: 15px;
            border-radius: 10px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4ecdc4;
            font-weight: 600;
        }

        .control-value {
            color: #fff;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        .warp-slider {
            width: 100%;
            margin: 5px 0;
        }

        .warp-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .warp-preset {
            padding: 12px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9em;
        }

        .warp-preset:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }

        /* ... (Phần CSS còn lại giữ nguyên) ... */
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1 class="title">MOCKUP K PRO</h1>
        <p class="subtitle">Advanced Mockup Editor with Realistic Texture Warping</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- UPLOAD MOCKUP -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> 1. Upload Mockup</h3>
                <button class="upload-btn" id="uploadMockupBtn">
                    <i class="fas fa-image"></i> Chọn Ảnh Mockup
                </button>
                <input type="file" id="mockupFile" accept="image/*" hidden>
            </div>

            <!-- UPLOAD VẬT LIỆU -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-layer-group"></i> 2. Upload Vật Liệu</h3>
                <button class="upload-btn secondary" id="uploadTextureBtn">
                    <i class="fas fa-images"></i> Chọn Ảnh Vật Liệu
                </button>
                <input type="file" id="textureFiles" accept="image/*" multiple hidden>
                
                <p style="margin: 15px 0 10px; color: #ccc;">Kéo thả vào canvas:</p>
                <div class="thumbnails" id="textureThumbnails">
                    <!-- Thumbnails sẽ hiện ở đây -->
                </div>
            </div>

            <!-- CÔNG CỤ CHỈNH SỬA -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-tools"></i> 3. Công Cụ Chỉnh Sửa</h3>
                <div class="tools">
                    <button class="tool-btn" id="transformBtn" title="Ctrl+T">
                        <i class="fas fa-expand-alt"></i>
                        <span>Transform</span>
                    </button>
                    <button class="tool-btn" id="fitSurfaceBtn">
                        <i class="fas fa-crop-alt"></i>
                        <span>Fit Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="warpSurfaceBtn">
                        <i class="fas fa-wave-square"></i>
                        <span>Warp Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="perspectiveBtn">
                        <i class="fas fa-cube"></i>
                        <span>Phối Cảnh</span>
                    </button>
                    <button class="tool-btn" id="autoColorBtn">
                        <i class="fas fa-adjust"></i>
                        <span>Cân Màu</span>
                    </button>
                    <button class="tool-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                    <button class="tool-btn" id="bringFrontBtn">
                        <i class="fas fa-arrow-up"></i>
                        <span>Lên Trước</span>
                    </button>
                    <button class="tool-btn" id="sendBackBtn">
                        <i class="fas fa-arrow-down"></i>
                        <span>Ra Sau</span>
                    </button>
                    <button class="tool-btn" id="zoomInBtn" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom In</span>
                    </button>
                    <button class="tool-btn" id="zoomOutBtn" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                        <span>Zoom Out</span>
                    </button>
                    <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Reset Zoom</span>
                    </button>
                </div>
            </div>

            <!-- SAVE / EXPORT -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-download"></i> 4. Lưu & Xuất File</h3>
                <button class="upload-btn save" id="saveBtn">
                    <i class="fas fa-save"></i> Lưu & Xuất Ảnh
                </button>
                <div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Hỗ trợ: PNG, JPG, PDF
                </div>
            </div>

            <!-- HƯỚNG DẪN -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-info-circle"></i> Hướng Dẫn Nhanh</h3>
                <ul style="color: #ccc; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                    <li><strong>1.</strong> Upload ảnh mockup trước</li>
                    <li><strong>2.</strong> Upload ảnh vật liệu (nhiều ảnh)</li>
                    <li><strong>3.</strong> Kéo thumbnail vào canvas</li>
                    <li><strong>4.</strong> Chọn ảnh → Transform (Ctrl+T)</li>
                    <li><strong>5.</strong> Nhấn "Warp Bề Mặt" để chỉnh độ cong</li>
                    <li><strong>6.</strong> Nhấn "Phối Cảnh" cho hiệu ứng 3D</li>
                    <li><strong>7.</strong> Nhấn "Fit Bề Mặt" để tự căn</li>
                    <li><strong>8.</strong> Nhấn "Cân Màu" để đồng bộ</li>
                    <li><strong>9.</strong> Lưu file PNG/JPG/PDF</li>
                    <li><strong>10.</strong> Dùng Undo/Redo để quay lại</li>
                </ul>
            </div>
        </div>

        <!-- CANVAS AREA -->
        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
                
                <!-- UNDO/REDO CONTROLS -->
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <!-- ZOOM CONTROLS -->
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInCanvas" title="Zoom In (vào trung tâm)">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="zoom-display" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOutCanvas" title="Zoom Out (từ trung tâm)">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn zoom-reset" id="zoomResetCanvas" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Kéo thả ảnh từ sidebar</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-arrows-alt"></i>
                    <span>Kéo để di chuyển</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-search"></i>
                    <span>Scroll để zoom theo chuột</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-save"></i>
                    <span>Ctrl+S để lưu, Ctrl+Z/Y để Undo/Redo</span>
                </div>
            </div>
        </div>
    </div>

    <!-- WARP MODAL -->
    <div class="overlay" id="warpOverlay"></div>
    <div class="warp-modal" id="warpModal">
        <h3 class="save-header">
            <i class="fas fa-wave-square"></i> Warp Bề Mặt
        </h3>
        
        <div class="warp-controls">
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong X</span>
                    <span class="control-value" id="warpXValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpXSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong Y</span>
                    <span class="control-value" id="warpYValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpYSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lồi</span>
                    <span class="control-value" id="bulgeValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="bulgeSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lõm</span>
                    <span class="control-value" id="pinchValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="pinchSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Gợn Sóng</span>
                    <span class="control-value" id="waveValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="waveSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Mờ Cạnh</span>
                    <span class="control-value" id="blendValue">50</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="warp-slider" id="blendSlider">
            </div>
        </div>
        
        <div class="warp-presets">
            <button class="warp-preset" data-preset="curve">Bề Mặt Cong</button>
            <button class="warp-preset" data-preset="wave">Gợn Sóng</button>
            <button class="warp-preset" data-preset="bulge">Phồng Lên</button>
            <button class="warp-preset" data-preset="pinch">Lõm Xuống</button>
            <button class="warp-preset" data-preset="fold">Nếp Gấp</button>
            <button class="warp-preset" data-preset="reset">Reset</button>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelWarp">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="applyWarp">
                <i class="fas fa-check"></i> Áp Dụng
            </button>
        </div>
    </div>

    <!-- SAVE MODAL -->
    <div class="overlay" id="saveOverlay"></div>
    <div class="save-options" id="saveModal">
        <!-- ... (Giữ nguyên) ... -->
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-info-circle"></i>
            <span id="statusText">Sẵn sàng - Kéo thả ảnh để bắt đầu</span>
        </div>
        <div class="status-item">
            <i class="fas fa-object-group"></i>
            <span>Đối tượng: <span id="selectedObj">Không có</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-expand-arrows-alt"></i>
            <span>Zoom: <span id="zoomStatus">100%</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-history"></i>
            <span>History: <span id="historyStatus">0/0</span></span>
        </div>
    </div>

    <script>
        // ========== KHỞI TẠO CANVAS FABRIC.JS ==========
        const canvas = new fabric.Canvas('main-canvas', {
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selection: true,
            selectionKey: 'shiftKey'
        });

        // ========== ZOOM FUNCTIONALITY ==========
        let zoomLevel = 1;
        const ZOOM_STEP = 0.2;
        const MIN_ZOOM = 0.1;
        const MAX_ZOOM = 5;
        let lastMouseX = 0;
        let lastMouseY = 0;

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ========== BIẾN TOÀN CỤC ==========
        let mockupImage = null;
        let textures = [];
        let activeTextureIndex = -1;
        let currentFormat = 'png';
        let currentQuality = 0.9;
        let warpSettings = {
            warpX: 0,
            warpY: 0,
            bulge: 0,
            pinch: 0,
            wave: 0,
            blend: 50
        };
        
        // ========== UNDO/REDO SYSTEM ==========
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        
        function saveToHistory() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const state = canvas.toDatalessJSON();
            history.push(state);
            historyIndex++;
            
            if (history.length > MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
            updateHistoryStatus();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã undo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã redo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        function updateHistoryStatus() {
            document.getElementById('historyStatus').textContent = 
                `${historyIndex}/${history.length-1}`;
        }
        
        canvas.on('object:modified', saveToHistory);
        canvas.on('object:added', saveToHistory);
        canvas.on('object:removed', saveToHistory);

        // ========== CẬP NHẬT TRẠNG THÁI ==========
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
            console.log('Status:', message);
        }

        // ========== ZOOM FUNCTIONS ==========
        function updateZoomDisplay() {
            const percent = Math.round(zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomStatus').textContent = percent + '%';
            
            canvas.setZoom(zoomLevel);
            canvas.renderAll();
        }

        function zoomToPoint(point, zoom) {
            const minZoom = MIN_ZOOM;
            const maxZoom = MAX_ZOOM;
            
            if (zoom < minZoom) zoom = minZoom;
            if (zoom > maxZoom) zoom = maxZoom;
            
            zoomLevel = zoom;
            canvas.zoomToPoint(point, zoomLevel);
            updateZoomDisplay();
            updateStatus(`Zoom: ${Math.round(zoomLevel * 100)}%`);
        }

        function zoomIn() {
            const center = canvas.getCenter();
            zoomToPoint(center, zoomLevel + ZOOM_STEP);
        }

        function zoomOut() {
            const center = canvas.getCenter();
            zoomToPoint(center, zoomLevel - ZOOM_STEP);
        }

        function resetZoom() {
            const center = canvas.getCenter();
            zoomToPoint(center, 1);
            updateStatus("Zoom đã reset về 100%");
        }

        canvas.on('mouse:wheel', function(opt) {
            opt.e.preventDefault();
            opt.e.stopPropagation();
            
            const delta = opt.e.deltaY;
            const zoom = canvas.getZoom();
            
            const pointer = canvas.getPointer(opt.e);
            
            let newZoom = delta > 0 ? zoom * 0.9 : zoom * 1.1;
            
            if (newZoom < MIN_ZOOM) newZoom = MIN_ZOOM;
            if (newZoom > MAX_ZOOM) newZoom = MAX_ZOOM;
            
            zoomToPoint(pointer, newZoom);
        });

        canvas.on('mouse:move', function(opt) {
            const pointer = canvas.getPointer(opt.e);
            lastMouseX = pointer.x;
            lastMouseY = pointer.y;
        });

        // ========== CÁC HÀM CƠ BẢN (Upload mockup, texture, v.v.) ==========
        // ... (Giữ nguyên các hàm upload từ code trước) ...
        
        // ========== 3. TRANSFORM (CTRL+T) ==========
        document.getElementById('transformBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                if (activeObj.hasControls) {
                    activeObj.set({
                        hasControls: false,
                        hasBorders: false
                    });
                    this.innerHTML = '<i class="fas fa-expand-alt"></i><span>Transform</span>';
                    saveToHistory();
                } else {
                    activeObj.set({
                        hasControls: true,
                        hasBorders: true
                    });
                    this.innerHTML = '<i class="fas fa-check"></i><span>Áp dụng</span>';
                }
                canvas.renderAll();
                updateStatus('Chế độ Transform: ' + (activeObj.hasControls ? 'Bật' : 'Tắt'));
            } else {
                updateStatus('Vui lòng chọn một đối tượng để transform');
            }
        });

        // ========== 4. FIT THEO BỀ MẶT NÂNG CAO ==========
        document.getElementById('fitSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                updateStatus('Vui lòng chọn đối tượng cần fit');
                return;
            }
            
            if (!mockupImage) {
                updateStatus('Cần có mockup để fit bề mặt');
                return;
            }
            
            // Lấy kích thước và vị trí mockup
            const mockupBounds = mockupImage.getBoundingRect();
            
            // Fit vật liệu vào 80% kích thước mockup
            const fitScale = 0.8;
            const targetWidth = mockupBounds.width * fitScale;
            const targetHeight = mockupBounds.height * fitScale;
            
            // Tính tỷ lệ scale
            const objBounds = activeObj.getBoundingRect();
            const scaleX = targetWidth / objBounds.width;
            const scaleY = targetHeight / objBounds.height;
            const scale = Math.min(scaleX, scaleY) * 0.95;
            
            // Áp dụng transform
            activeObj.set({
                scaleX: activeObj.scaleX * scale,
                scaleY: activeObj.scaleY * scale,
                left: mockupBounds.left + (mockupBounds.width - objBounds.width * scale) / 2,
                top: mockupBounds.top + (mockupBounds.height - objBounds.height * scale) / 2,
                opacity: 0.9,
                shadow: new fabric.Shadow({
                    color: 'rgba(0,0,0,0.3)',
                    blur: 15,
                    offsetX: 5,
                    offsetY: 5
                })
            });
            
            // Thêm hiệu ứng blend
            activeObj.set({
                filters: [
                    new fabric.Image.filters.Brightness({ brightness: 0.05 }),
                    new fabric.Image.filters.Contrast({ contrast: 0.1 })
                ]
            });
            activeObj.applyFilters();
            
            canvas.renderAll();
            updateStatus('Đã fit ảnh theo bề mặt mockup');
            saveToHistory();
        });

        // ========== 5. WARP BỀ MẶT - THUẬT TOÁN NÂNG CAO ==========
        const warpModal = document.getElementById('warpModal');
        const warpOverlay = document.getElementById('warpOverlay');
        
        document.getElementById('warpSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                updateStatus('Vui lòng chọn đối tượng cần warp');
                return;
            }
            
            warpModal.classList.add('active');
            warpOverlay.classList.add('active');
            updateStatus('Đang mở công cụ Warp bề mặt');
        });

        // Cập nhật giá trị warp
        const warpSliders = ['warpXSlider', 'warpYSlider', 'bulgeSlider', 'pinchSlider', 'waveSlider', 'blendSlider'];
        const warpValues = ['warpXValue', 'warpYValue', 'bulgeValue', 'pinchValue', 'waveValue', 'blendValue'];
        
        warpSliders.forEach((sliderId, index) => {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(warpValues[index]);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
                const settingKey = sliderId.replace('Slider', '').replace(/([A-Z])/g, match => match.toLowerCase());
                warpSettings[settingKey] = parseInt(this.value);
                
                // Xem trước warp
                previewWarpEffect();
            });
        });

        // Presets warp
        document.querySelectorAll('.warp-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const preset = this.dataset.preset;
                
                switch(preset) {
                    case 'curve':
                        setWarpPreset(20, 15, 30, 0, 0, 60);
                        break;
                    case 'wave':
                        setWarpPreset(10, 10, 0, 0, 70, 70);
                        break;
                    case 'bulge':
                        setWarpPreset(0, 0, 80, 0, 0, 50);
                        break;
                    case 'pinch':
                        setWarpPreset(0, 0, 0, 70, 0, 50);
                        break;
                    case 'fold':
                        setWarpPreset(-25, 30, 40, 20, 50, 80);
                        break;
                    case 'reset':
                        setWarpPreset(0, 0, 0, 0, 0, 50);
                        break;
                }
                
                previewWarpEffect();
            });
        });

        function setWarpPreset(warpX, warpY, bulge, pinch, wave, blend) {
            warpSettings = { warpX, warpY, bulge, pinch, wave, blend };
            
            document.getElementById('warpXSlider').value = warpX;
            document.getElementById('warpYSlider').value = warpY;
            document.getElementById('bulgeSlider').value = bulge;
            document.getElementById('pinchSlider').value = pinch;
            document.getElementById('waveSlider').value = wave;
            document.getElementById('blendSlider').value = blend;
            
            document.getElementById('warpXValue').textContent = warpX;
            document.getElementById('warpYValue').textContent = warpY;
            document.getElementById('bulgeValue').textContent = bulge;
            document.getElementById('pinchValue').textContent = pinch;
            document.getElementById('waveValue').textContent = wave;
            document.getElementById('blendValue').textContent = blend;
        }

        // Xem trước hiệu ứng warp
        function previewWarpEffect() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) return;
            
            // Tạo bản sao tạm thời để xem trước
            const tempObj = fabric.util.object.clone(activeObj);
            
            // Áp dụng hiệu ứng warp
            applyWarpToObject(tempObj, false);
            
            // Hiển thị tạm thời
            canvas.remove(activeObj);
            canvas.add(tempObj);
            canvas.setActiveObject(tempObj);
            canvas.renderAll();
        }

        // Áp dụng warp thực tế
        function applyWarpToObject(obj, isFinal = true) {
            if (!obj) return;
            
            const { warpX, warpY, bulge, pinch, wave, blend } = warpSettings;
            
            // Tính toán các tham số biến dạng
            const warpFactorX = warpX / 100;
            const warpFactorY = warpY / 100;
            const bulgeFactor = bulge / 100;
            const pinchFactor = pinch / 100;
            const waveFactor = wave / 100;
            const blendFactor = blend / 100;
            
            // Áp dụng các biến đổi
            obj.set({
                // Biến dạng tổng quát
                skewX: obj.skewX + warpX * 0.3,
                skewY: obj.skewY + warpY * 0.3,
                
                // Hiệu ứng phồng/lõm
                scaleX: obj.scaleX * (1 + (bulgeFactor - pinchFactor) * 0.2),
                scaleY: obj.scaleY * (1 + (bulgeFactor - pinchFactor) * 0.2),
                
                // Hiệu ứng gợn sóng
                ...(waveFactor > 0 && {
                    scaleX: obj.scaleX * (1 + Math.sin(Date.now() * 0.001) * waveFactor * 0.1),
                    scaleY: obj.scaleY * (1 + Math.cos(Date.now() * 0.001) * waveFactor * 0.1)
                }),
                
                // Độ trong suốt ở cạnh
                opacity: 0.8 + blendFactor * 0.2,
                
                // Hiệu ứng bóng đổ cho chiều sâu
                shadow: new fabric.Shadow({
                    color: `rgba(0,0,0,${0.2 + blendFactor * 0.3})`,
                    blur: 10 + blend * 0.5,
                    offsetX: warpX * 0.2,
                    offsetY: warpY * 0.2
                }),
                
                // Gradient overlay cho hiệu ứng blend
                fill: 'rgba(0,0,0,0)'
            });
            
            // Tạo gradient mask cho các cạnh
            if (blendFactor > 0.3) {
                const gradient = new fabric.Gradient({
                    type: 'radial',
                    coords: {
                        x1: 0.5,
                        y1: 0.5,
                        x2: 0.5,
                        y2: 0.5,
                        r1: 0,
                        r2: 1
                    },
                    colorStops: [
                        { offset: 0, color: `rgba(255,255,255,${1 - blendFactor * 0.5})` },
                        { offset: 0.7, color: `rgba(255,255,255,${1 - blendFactor * 0.3})` },
                        { offset: 1, color: `rgba(255,255,255,${1 - blendFactor})` }
                    ]
                });
                
                // Tạo overlay gradient
                const gradientOverlay = new fabric.Rect({
                    left: obj.left,
                    top: obj.top,
                    width: obj.width * obj.scaleX,
                    height: obj.height * obj.scaleY,
                    fill: gradient,
                    selectable: false,
                    evented: false
                });
                
                if (isFinal) {
                    canvas.add(gradientOverlay);
                    canvas.sendToBack(gradientOverlay);
                }
            }
            
            // Thêm filter để blend với background
            const filters = [];
            
            if (bulgeFactor > 0) {
                filters.push(new fabric.Image.filters.Blur({
                    blur: bulgeFactor * 0.1
                }));
            }
            
            if (waveFactor > 0) {
                filters.push(new fabric.Image.filters.Noise({
                    noise: waveFactor * 20
                }));
            }
            
            // Hiệu ứng màu để blend với mockup
            filters.push(
                new fabric.Image.filters.Brightness({
                    brightness: blendFactor * 0.1
                }),
                new fabric.Image.filters.Saturation({
                    saturation: -blendFactor * 0.2
                })
            );
            
            if (filters.length > 0) {
                obj.filters = filters;
                obj.applyFilters();
            }
            
            return obj;
        }

        // Áp dụng warp
        document.getElementById('applyWarp').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                applyWarpToObject(activeObj, true);
                canvas.renderAll();
                updateStatus('Đã áp dụng hiệu ứng warp cho bề mặt');
                saveToHistory();
            }
            
            closeWarpModal();
        });

        // Đóng modal warp
        document.getElementById('cancelWarp').addEventListener('click', closeWarpModal);
        warpOverlay.addEventListener('click', closeWarpModal);

        function closeWarpModal() {
            warpModal.classList.remove('active');
            warpOverlay.classList.remove('active');
            
            // Khôi phục đối tượng gốc
            canvas.renderAll();
        }

        // ========== 6. PHỐI CẢNH 3D ==========
        document.getElementById('perspectiveBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                updateStatus('Vui lòng chọn đối tượng cần tạo phối cảnh');
                return;
            }
            
            // Áp dụng hiệu ứng phối cảnh 3D
            activeObj.set({
                // Biến dạng phối cảnh
                skewX: activeObj.skewX + 15,
                skewY: activeObj.skewY - 10,
                
                // Thay đổi tỷ lệ để tạo chiều sâu
                scaleX: activeObj.scaleX * 0.9,
                scaleY: activeObj.scaleY * 0.85,
                
                // Xoay nhẹ
                angle: activeObj.angle + 5,
                
                // Đổ bóng cho hiệu ứng 3D
                shadow: new fabric.Shadow({
                    color: 'rgba(0,0,0,0.4)',
                    blur: 20,
                    offsetX: 10,
                    offsetY: 10
                }),
                
                // Thêm gradient overlay
                opacity: 0.85
            });
            
            // Thêm filter để blend
            activeObj.filters = [
                new fabric.Image.filters.Brightness({ brightness: 0.08 }),
                new fabric.Image.filters.Contrast({ contrast: 0.12 }),
                new fabric.Image.filters.GradientTransparency({
                    threshold: 100
                })
            ];
            activeObj.applyFilters();
            
            canvas.renderAll();
            updateStatus('Đã áp dụng hiệu ứng phối cảnh 3D');
            saveToHistory();
        });

        // ========== 7. AUTO CÂN MÀU NÂNG CAO ==========
        document.getElementById('autoColorBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và đối tượng để cân màu');
                return;
            }
            
            updateStatus('Đang phân tích và cân màu nâng cao...');
            
            // Tạo canvas ẩn để phân tích màu
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // Vẽ mockup để lấy màu trung bình
            tempCanvas.width = mockupImage.width;
            tempCanvas.height = mockupImage.height;
            
            // Sử dụng CamanJS để phân tích màu
            Caman(tempCanvas, function() {
                this.brightness(5).contrast(5).saturation(-5).render();
                
                // Áp dụng filter tương tự cho đối tượng
                activeObj.filters = [
                    new fabric.Image.filters.Brightness({ brightness: 0.05 }),
                    new fabric.Image.filters.Contrast({ contrast: 0.08 }),
                    new fabric.Image.filters.Saturation({ saturation: -0.05 }),
                    new fabric.Image.filters.BlendColor({
                        color: '#808080',
                        mode: 'multiply',
                        alpha: 0.1
                    })
                ];
                
                activeObj.applyFilters();
                canvas.renderAll();
                updateStatus('Đã cân màu nâng cao với mockup');
                saveToHistory();
            });
        });

        // ========== CÁC CÔNG CỤ KHÁC ==========
        document.getElementById('removeBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                canvas.remove(activeObj);
                updateStatus('Đã xóa đối tượng');
                updateSelectedObject();
                saveToHistory();
            }
        });

        document.getElementById('bringFrontBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.bringToFront();
                canvas.renderAll();
                updateStatus('Đã đưa lên lớp trên');
                saveToHistory();
            }
        });

        document.getElementById('sendBackBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                activeObj.sendToBack();
                if (mockupImage) {
                    mockupImage.bringToFront();
                }
                canvas.renderAll();
                updateStatus('Đã đưa xuống lớp dưới');
                saveToHistory();
            }
        });

        // ========== UNDO/REDO BUTTONS ==========
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);

        // ========== PHÍM TẮT ==========
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                document.getElementById('transformBtn').click();
            }
            
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveBtn').click();
            }
            
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redo();
            }
            
            // Warp phím tắt: Ctrl+W
            if (e.ctrlKey && e.key === 'w') {
                e.preventDefault();
                document.getElementById('warpSurfaceBtn').click();
            }
        });

        // ========== SAVE/EXPORT FUNCTIONALITY ==========
        // ... (Giữ nguyên phần save/export từ code trước) ...

        // ========== THEO DÕI ĐỐI TƯỢNG ĐANG CHỌN ==========
        canvas.on('selection:created', updateSelectedObject);
        canvas.on('selection:updated', updateSelectedObject);
        canvas.on('selection:cleared', updateSelectedObject);

        function updateSelectedObject() {
            const activeObj = canvas.getActiveObject();
            const selectedObjElement = document.getElementById('selectedObj');
            
            if (activeObj && activeObj !== mockupImage) {
                selectedObjElement.textContent = 'Đã chọn';
                selectedObjElement.style.color = '#4ecdc4';
            } else {
                selectedObjElement.textContent = 'Không có';
                selectedObjElement.style.color = '#ff6b6b';
            }
        }

        // ========== KHỞI TẠO ==========
        updateZoomDisplay();
        updateStatus('Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu');
        updateSelectedObject();
        updateHistoryButtons();
        updateHistoryStatus();
        
        // Lưu state ban đầu
        setTimeout(() => {
            saveToHistory();
        }, 100);

        // ========== UPLOAD FUNCTIONALITY ==========
        // ... (Thêm các hàm upload từ code cũ ở đây) ...
        
        // 1. UPLOAD MOCKUP
        document.getElementById('uploadMockupBtn').addEventListener('click', () => {
            document.getElementById('mockupFile').click();
        });

        document.getElementById('mockupFile').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (mockupImage) {
                        canvas.remove(mockupImage);
                    }
                    
                    fabric.Image.fromURL(event.target.result, function(img) {
                        mockupImage = img;
                        mockupImage.selectable = false;
                        mockupImage.evented = false;
                        mockupImage.hasControls = false;
                        mockupImage.hasBorders = false;
                        
                        const scaleX = canvas.width / img.width;
                        const scaleY = canvas.height / img.height;
                        const scale = Math.min(scaleX, scaleY) * 0.9;
                        
                        img.scale(scale);
                        img.set({
                            left: (canvas.width - img.width * scale) / 2,
                            top: (canvas.height - img.height * scale) / 2,
                            originX: 'left',
                            originY: 'top'
                        });
                        
                        canvas.add(img);
                        canvas.sendToBack(img);
                        updateStatus('Mockup đã được tải lên!');
                        saveToHistory();
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // 2. UPLOAD VẬT LIỆU
        document.getElementById('uploadTextureBtn').addEventListener('click', () => {
            document.getElementById('textureFiles').click();
        });

        document.getElementById('textureFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const thumbnailsContainer = document.getElementById('textureThumbnails');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    textures.push({
                        id: Date.now() + index,
                        url: event.target.result,
                        name: file.name,
                        element: null
                    });
                    
                    const thumbnail = document.createElement('img');
                    thumbnail.src = event.target.result;
                    thumbnail.className = 'thumbnail';
                    thumbnail.draggable = true;
                    thumbnail.dataset.index = textures.length - 1;
                    
                    thumbnail.addEventListener('click', function() {
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        activeTextureIndex = parseInt(this.dataset.index);
                        updateStatus(`Đã chọn: ${textures[activeTextureIndex].name}`);
                    });
                    
                    thumbnail.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('textureIndex', this.dataset.index);
                    });
                    
                    thumbnailsContainer.appendChild(thumbnail);
                    
                    if (index === 0) {
                        thumbnail.click();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            updateStatus(`Đã tải lên ${files.length} ảnh vật liệu`);
        });

        // KÉO THẢ VÀO CANVAS
        canvas.on('drop', function(event) {
            event.e.preventDefault();
            
            const textureIndex = event.e.dataTransfer.getData('textureIndex');
            if (textureIndex === '') return;
            
            const index = parseInt(textureIndex);
            if (textures[index]) {
                const texture = textures[index];
                
                fabric.Image.fromURL(texture.url, function(img) {
                    const maxSize = 200;
                    const scale = maxSize / Math.max(img.width, img.height);
                    
                    img.set({
                        left: event.e.offsetX - (img.width * scale) / 2,
                        top: event.e.offsetY - (img.height * scale) / 2,
                        scaleX: scale,
                        scaleY: scale,
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false
                    });
                    
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    updateStatus(`Đã thêm "${texture.name}" vào mockup`);
                    updateSelectedObject();
                    saveToHistory();
                });
            }
        });

        canvas.on('dragover', function(event) {
            event.e.preventDefault();
        });
    </script>
</body>
</html>
