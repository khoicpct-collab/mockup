// ========== BIẾN CHO CÔNG CỤ LASO CẢI TIẾN ==========
let isLassoMode = false;
let lassoPoints = [];
let lassoPath = null;
let isDrawingLasso = false;
// Thêm biến để quản lý trạng thái canvas
let originalSelectionState = true;

// ========== CÔNG CỤ LASO CẢI TIẾN ==========
function activateLassoMode() {
    currentToolMode = 'lasso';
    isLassoMode = true;
    isDrawingLasso = false;
    lassoPoints = [];
    
    // QUAN TRỌNG: Tắt selection và event handling của Fabric.js
    originalSelectionState = canvas.selection;
    canvas.selection = false;
    canvas.defaultCursor = 'crosshair';
    canvas.hoverCursor = 'crosshair';
    
    // Vô hiệu hóa tất cả các đối tượng để không bị kéo
    canvas.getObjects().forEach(obj => {
        if (obj.name === 'texture') {
            obj.selectable = false;
            obj.evented = false;
        }
    });
    
    updateToolButtons();
    updateStatus('Laso Tool: Click và kéo để vẽ vùng chọn, Double-click để kết thúc');
}

function startLassoDrawing(event) {
    if (!isLassoMode) return;
    
    // QUAN TRỌNG: Ngăn chặn Fabric.js xử lý sự kiện mặc định
    event.e.preventDefault();
    event.e.stopPropagation();
    
    isDrawingLasso = true;
    const pointer = canvas.getPointer(event.e);
    
    lassoPoints = [{x: pointer.x, y: pointer.y}];
    
    // Tạo path mới với đường cong mượt
    lassoPath = new fabric.Path(`M ${pointer.x} ${pointer.y}`, {
        fill: 'rgba(255, 0, 0, 0.2)',
        stroke: '#ff0000',
        strokeWidth: 2,
        strokeLineCap: 'round',
        strokeLineJoin: 'round',
        selectable: false,
        evented: false,
        objectCaching: false
    });
    
    canvas.add(lassoPath);
    canvas.renderAll();
}

function continueLassoDrawing(event) {
    if (!isLassoMode || !isDrawingLasso) return;
    
    // Ngăn chặn sự kiện mặc định
    event.e.preventDefault();
    event.e.stopPropagation();
    
    const pointer = canvas.getPointer(event.e);
    lassoPoints.push({x: pointer.x, y: pointer.y});
    
    // Cập nhật path với đường cong mượt
    if (lassoPoints.length >= 2) {
        let pathString = `M ${lassoPoints[0].x} ${lassoPoints[0].y}`;
        
        // Tạo đường cong quadratic để mượt hơn
        for (let i = 1; i < lassoPoints.length; i++) {
            const prevPoint = lassoPoints[i-1];
            const currentPoint = lassoPoints[i];
            
            // Sử dụng đường thẳng đơn giản trước, sau đó có thể chuyển sang đường cong
            pathString += ` L ${currentPoint.x} ${currentPoint.y}`;
        }
        
        lassoPath.set({ path: pathString });
        canvas.renderAll();
    }
}

function endLassoDrawing(event) {
    if (!isLassoMode || !isDrawingLasso) return;
    
    event.e.preventDefault();
    event.e.stopPropagation();
    
    if (event.e.type === 'mouseup') {
        // Kiểm tra nếu double-click
        const now = Date.now();
        if (lassoPath.lastClickTime && now - lassoPath.lastClickTime < 300) {
            finishLassoSelection();
        } else {
            lassoPath.lastClickTime = now;
        }
    }
}

function finishLassoSelection() {
    if (lassoPoints.length < 3) {
        cleanupLasso();
        updateStatus('Vùng chọn quá nhỏ. Vui lòng vẽ vùng lớn hơn.');
        return;
    }
    
    // Đóng path bằng cách nối điểm cuối với điểm đầu
    const firstPoint = lassoPoints[0];
    
    let pathString = lassoPath.path.join(' ');
    pathString += ` L ${firstPoint.x} ${firstPoint.y} Z`;
    
    lassoPath.set({ 
        path: pathString,
        fill: 'rgba(255, 0, 0, 0.3)'
    });
    
    canvas.renderAll();
    isDrawingLasso = false;
    
    updateStatus('Đã tạo vùng chọn. Nhấn Delete để xóa phần bên trong vùng này.');
}

function deleteLassoArea() {
    if (!isLassoMode || !lassoPath || lassoPoints.length < 3) {
        updateStatus('Vui lòng tạo vùng chọn trước khi xóa');
        return;
    }
    
    const activeObj = canvas.getActiveObject();
    if (!activeObj || activeObj.name !== 'texture') {
        updateStatus('Vui lòng chọn một vật liệu trước khi xóa vùng chọn');
        return;
    }
    
    // Tạo một canvas ẩn để xử lý
    const tempCanvas = document.createElement('canvas');
    const ctx = tempCanvas.getContext('2d');
    
    // Lấy kích thước texture
    const img = activeObj.getElement();
    tempCanvas.width = img.width;
    tempCanvas.height = img.height;
    
    // Vẽ texture gốc
    ctx.drawImage(img, 0, 0);
    
    // Tạo path từ các điểm lasso (chuyển đổi tọa độ)
    ctx.beginPath();
    
    // Chuyển đổi tọa độ từ canvas sang image
    const matrix = activeObj.calcTransformMatrix();
    const invertedMatrix = fabric.util.invertTransform(matrix);
    
    // Điểm đầu tiên
    const firstTransformed = fabric.util.transformPoint(
        new fabric.Point(lassoPoints[0].x, lassoPoints[0].y),
        invertedMatrix
    );
    ctx.moveTo(firstTransformed.x, firstTransformed.y);
    
    // Vẽ đường qua các điểm
    for (let i = 1; i < lassoPoints.length; i++) {
        const transformedPoint = fabric.util.transformPoint(
            new fabric.Point(lassoPoints[i].x, lassoPoints[i].y),
            invertedMatrix
        );
        ctx.lineTo(transformedPoint.x, transformedPoint.y);
    }
    
    // Đóng path
    ctx.closePath();
    
    // Xóa phần bên trong path
    ctx.globalCompositeOperation = 'destination-out';
    ctx.fill();
    
    // Tạo ảnh mới
    fabric.Image.fromURL(tempCanvas.toDataURL(), function(newImg) {
        newImg.set({
            left: activeObj.left,
            top: activeObj.top,
            scaleX: activeObj.scaleX,
            scaleY: activeObj.scaleY,
            angle: activeObj.angle,
            opacity: activeObj.opacity,
            hasControls: true,
            hasBorders: true,
            cornerStyle: 'circle',
            cornerColor: '#4ecdc4',
            borderColor: '#4ecdc4',
            cornerSize: 12,
            transparentCorners: false,
            name: 'texture'
        });
        
        canvas.remove(activeObj);
        canvas.add(newImg);
        canvas.setActiveObject(newImg);
        
        // Dọn dẹp lasso
        cleanupLasso();
        
        canvas.renderAll();
        saveToHistory();
        updateStatus('Đã xóa phần bên trong vùng chọn thành công!');
    });
}

function cleanupLasso() {
    if (lassoPath) {
        canvas.remove(lassoPath);
        lassoPath = null;
    }
    
    lassoPoints = [];
    isDrawingLasso = false;
    
    // Khôi phục lại trạng thái canvas
    canvas.selection = originalSelectionState;
    canvas.defaultCursor = 'default';
    canvas.hoverCursor = 'move';
    
    // Kích hoạt lại các đối tượng texture
    canvas.getObjects().forEach(obj => {
        if (obj.name === 'texture') {
            obj.selectable = true;
            obj.evented = true;
        }
    });
    
    canvas.renderAll();
}

// ========== CHUYỂN ĐỔI CÔNG CỤ ==========
function setToolMode(mode) {
    // Dọn dẹp mode cũ
    if (currentToolMode === 'draw') {
        deactivateDrawingMode();
    } else if (currentToolMode === 'lasso') {
        cleanupLasso();
        // Xóa các event listener cũ
        canvas.off('mouse:down', lassoMouseDownHandler);
        canvas.off('mouse:move', lassoMouseMoveHandler);
        canvas.off('mouse:up', lassoMouseUpHandler);
    }
    
    currentToolMode = mode;
    
    // Xóa tất cả active tool class
    document.querySelectorAll('.tools .tool-btn').forEach(btn => {
        btn.classList.remove('active-tool');
    });

    // Thiết lập các event handlers cho Laso
    if (mode === 'lasso') {
        document.getElementById('lassoBtn').classList.add('active-tool');
        activateLassoMode();
        
        // Sử dụng hàm xử lý riêng để có thể remove sau
        lassoMouseDownHandler = function(opt) { startLassoDrawing(opt); };
        lassoMouseMoveHandler = function(opt) { continueLassoDrawing(opt); };
        lassoMouseUpHandler = function(opt) { endLassoDrawing(opt); };
        
        canvas.on('mouse:down', lassoMouseDownHandler);
        canvas.on('mouse:move', lassoMouseMoveHandler);
        canvas.on('mouse:up', lassoMouseUpHandler);
    } 
    else if (mode === 'hand') {
        document.getElementById('handToolBtn').classList.add('active-tool');
        canvas.selection = false;
        canvas.defaultCursor = 'grab';
        canvas.hoverCursor = 'grab';
        updateStatus('Chế độ Bàn Tay (Pan) được kích hoạt');
    } 
    else if (mode === 'draw') {
        document.getElementById('drawBtn').classList.add('active-tool');
        activateDrawingMode();
    }
    else {
        document.getElementById('transformBtn').classList.add('active-tool');
        canvas.selection = true;
        canvas.defaultCursor = 'default';
        canvas.hoverCursor = 'move';
        updateStatus('Chế độ Select/Transform được kích hoạt');
    }
    
    canvas.renderAll();
}

// Khai báo các handler cho laso
let lassoMouseDownHandler = null;
let lassoMouseMoveHandler = null;
let lassoMouseUpHandler = null;

// ========== CẬP NHẬT PHÍM TẮT ==========
document.addEventListener('keydown', function(e) {
    if (e.key.toLowerCase() === 'h' && currentToolMode !== 'hand') { 
        e.preventDefault(); 
        setToolMode('hand');
    } else if (e.key === 'Escape' || (e.ctrlKey && e.key === 't')) { 
        e.preventDefault(); 
        setToolMode('select');
    } else if (e.key.toLowerCase() === 'd') { 
        e.preventDefault(); 
        if (currentToolMode === 'draw') {
            setToolMode('select');
        } else {
            setToolMode('draw');
        }
    } else if (e.key.toLowerCase() === 'l') { 
        e.preventDefault(); 
        if (currentToolMode === 'lasso') {
            setToolMode('select');
        } else {
            setToolMode('lasso');
        }
    } else if (e.key.toLowerCase() === 'w') { 
        e.preventDefault(); 
        applyAutoWarp();
    } else if (e.ctrlKey && e.key === 'z') { 
        e.preventDefault(); 
        document.getElementById('undoBtn').click(); 
    } else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) { 
        e.preventDefault(); 
        document.getElementById('redoBtn').click(); 
    } else if (e.key === 'Delete' || e.key === 'Backspace') {
        e.preventDefault(); 
        if (currentToolMode === 'lasso' && lassoPath) {
            deleteLassoArea();
        } else {
            document.getElementById('removeBtn').click(); 
        }
    }
});

// ========== CẬP NHẬT NÚT XÓA ==========
document.getElementById('removeBtn').addEventListener('click', function() {
    if (currentToolMode === 'lasso' && lassoPath) {
        deleteLassoArea();
    } else {
        const activeObj = canvas.getActiveObject();
        if (activeObj && activeObj !== mockupImage) {
            canvas.remove(activeObj);
            updateStatus('Đã xóa đối tượng');
            updateSelectedObject();
            saveToHistory();
        }
    }
});
