<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.8/fx.js"></script>
    
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background-color: #1c2a35;
            padding: 10px 20px;
            text-align: center;
            border-bottom: 3px solid #4ecdc4;
        }

        .title {
            margin: 0;
            font-size: 1.8em;
            color: #4ecdc4;
            font-weight: 700;
        }

        .subtitle {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background-color: #34495e;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #2c3e50;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #5e7280;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1em;
            color: #ecf0f1;
            margin: 0 0 10px 0;
            border-left: 4px solid #4ecdc4;
            padding-left: 8px;
        }

        .upload-btn {
            width: 100%;
            padding: 12px;
            background-color: #4ecdc4;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin-bottom: 8px;
        }

        .upload-btn:hover {
            background-color: #3aa59e;
            transform: translateY(-1px);
        }

        .upload-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .upload-btn.secondary:hover {
            background-color: #47627a;
        }
        
        .upload-btn.save {
            background-color: #e74c3c;
            color: white;
        }

        .upload-btn.save:hover {
            background-color: #c0392b;
        }

        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #5e7280;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
        }

        .thumbnail:hover, .thumbnail.active {
            border-color: #4ecdc4;
            transform: scale(1.05);
        }

        .tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            background-color: #3a5369;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            padding: 8px 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tool-btn i {
            font-size: 1.2em;
            margin-bottom: 4px;
        }

        .tool-btn:hover {
            background-color: #4ecdc4;
            color: #2c3e50;
        }
        
        .tool-btn.active-tool {
            background-color: #4ecdc4;
            color: #2c3e50;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
        }

        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #2c3e50;
            padding: 15px;
            position: relative;
        }

        .canvas-container {
            flex: 1;
            border: 1px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            background-color: #1c2a35;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }

        #main-canvas {
            display: block;
        }

        .canvas-info {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0;
            font-size: 0.85em;
            color: #bdc3c7;
        }

        .canvas-info-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        .history-controls, .zoom-controls {
            position: absolute;
            z-index: 10;
        }

        .history-controls {
            top: 10px;
            right: 10px;
        }
        
        .zoom-controls {
            bottom: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            background: rgba(30, 30, 50, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
        }

        .history-btn, .zoom-btn {
            background: rgba(78, 205, 196, 0.1);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
        }

        .history-btn:hover, .zoom-btn:hover {
            background: #4ecdc4;
            color: #1c2a35;
        }
        
        .zoom-display {
            color: white;
            padding: 0 10px;
            font-weight: bold;
        }

        .status-bar {
            background-color: #1c2a35;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #bdc3c7;
            border-top: 1px solid #4ecdc4;
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .status-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        .warp-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            background: rgba(30, 30, 50, 0.95);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
            cursor: move;
            user-select: none;
            width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .warp-modal.active {
            display: block;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            cursor: grab;
        }

        .modal-header h3 {
            margin: 0;
            color: #4ecdc4;
            font-size: 1.1em;
        }

        .close-modal-btn {
            background: none;
            border: none;
            color: #4ecdc4;
            font-size: 18px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .close-modal-btn:hover {
            background: rgba(78, 205, 196, 0.2);
            color: #fff;
        }

        .warp-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin: 15px 0;
        }

        .warp-control {
            background: rgba(60, 60, 100, 0.8);
            padding: 12px;
            border-radius: 8px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4ecdc4;
            font-weight: 600;
            font-size: 0.9em;
        }

        .control-value {
            color: #fff;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
            font-size: 0.9em;
        }

        .warp-slider {
            width: 100%;
            margin: 5px 0;
        }

        .warp-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .warp-preset {
            padding: 10px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.85em;
        }

        .warp-preset:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 15px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 0.9em;
        }

        .modal-btn.primary {
            background-color: #4ecdc4;
            color: #2c3e50;
        }

        .modal-btn.primary:hover {
            background-color: #3aa59e;
        }

        .modal-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .modal-btn.secondary:hover {
            background-color: #47627a;
        }

        .modal-btn.complete {
            background-color: #27ae60;
            color: white;
        }

        .modal-btn.complete:hover {
            background-color: #219955;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .overlay.active {
            display: block;
        }
        
        .displacement-control {
            grid-column: 1 / span 2;
        }
        
        #exportFileName {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }
        
        #exportFormat {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }

        .drawing-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(30, 30, 50, 0.8);
            padding: 10px;
            border-radius: 8px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .drawing-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .drawing-control label {
            color: #4ecdc4;
            font-size: 0.9em;
            min-width: 60px;
        }

        .drawing-control input {
            width: 80px;
        }

        .drawing-color-picker {
            width: 30px;
            height: 30px;
            border: 2px solid #4ecdc4;
            border-radius: 4px;
            cursor: pointer;
            background: #4ecdc4;
        }

        /* MODAL TẠO DISPLACEMENT MAP */
        .disp-creation-modal {
            display: none;
            position: fixed;
            z-index: 1003;
            background: rgba(30, 30, 50, 0.98);
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
            width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .disp-creation-modal.active {
            display: block;
        }

        .disp-preview-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }

        .disp-preview-box {
            background: rgba(40, 40, 60, 0.8);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
        }

        .disp-preview-box h4 {
            color: #4ecdc4;
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .disp-canvas {
            max-width: 100%;
            max-height: 300px;
            border: 2px solid #4ecdc4;
            border-radius: 5px;
            background: #1c2a35;
        }

        .disp-controls {
            background: rgba(60, 60, 100, 0.8);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .disp-slider-group {
            margin-bottom: 15px;
        }

        .disp-slider-label {
            display: flex;
            justify-content: space-between;
            color: #4ecdc4;
            margin-bottom: 5px;
            font-size: 0.9em;
        }

        .disp-slider-value {
            color: white;
            font-weight: bold;
        }

        .disp-preset-buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .disp-preset-btn {
            padding: 10px;
            background: rgba(70, 70, 120, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.85em;
        }

        .disp-preset-btn:hover {
            background: rgba(78, 205, 196, 0.8);
            transform: translateY(-2px);
        }

        .disp-preset-btn.active {
            background: #4ecdc4;
            color: #2c3e50;
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.8);
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 10px;
        }

        .tab-btn {
            padding: 10px 20px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-btn:hover {
            background: rgba(78, 205, 196, 0.6);
        }

        .tab-btn.active {
            background: #4ecdc4;
            color: #2c3e50;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-box {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            color: #a9c7c7;
            font-size: 0.9em;
        }

        .info-box h4 {
            color: #4ecdc4;
            margin: 0 0 10px 0;
            font-size: 1em;
        }

        .info-box ul {
            margin: 10px 0;
            padding-left: 20px;
        }

        .info-box li {
            margin-bottom: 5px;
        }

        /* Lasso tool styles */
        .lasso-point {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ff0000;
            border-radius: 50%;
            z-index: 100;
            pointer-events: none;
        }
        
        .lasso-line {
            position: absolute;
            background: #ff0000;
            height: 2px;
            z-index: 99;
            pointer-events: none;
        }
        
        .lasso-preview {
            position: absolute;
            background: rgba(255, 0, 0, 0.2);
            border: 2px solid #ff0000;
            z-index: 98;
            pointer-events: none;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">MOCKUP K PRO</h1>
        <p class="subtitle">Advanced Mockup Editor with Realistic Texture Warping</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> 1. Upload Mockup</h3>
                <button class="upload-btn" id="uploadMockupBtn">
                    <i class="fas fa-image"></i> Chọn Ảnh Mockup
                </button>
                <input type="file" id="mockupFile" accept="image/*" hidden>
            </div>
            
            <div class="section">
                <h3 class="section-title"><i class="fas fa-robot"></i> 2. Displacement Map & Hoàn Tất</h3>
                <button class="upload-btn secondary" id="autoCreateDispBtn">
                    <i class="fas fa-magic"></i> Tạo Displacement Map
                </button>
                <button class="upload-btn" id="finishAllBtn" style="background: #27ae60;">
                    <i class="fas fa-check-circle"></i> Hoàn Tất Tất Cả
                </button>
                
                <div style="margin-top: 10px; font-size: 0.8em; color: #a9c7c7; background: rgba(78, 205, 196, 0.1); padding: 8px; border-radius: 5px;">
                    <p><strong>Cách hoạt động:</strong></p>
                    <p>1. Upload mockup (ảnh nền)</p>
                    <p>2. Nhấn "Tạo Displacement Map" để tự động tạo map 3D</p>
                    <p>3. Upload vật liệu và kéo vào mockup</p>
                    <p>4. Sử dụng công cụ Laso để xóa phần thừa</p>
                    <p>5. Nhấn "Hoàn Tất Tất Cả" để xuất ảnh</p>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-layer-group"></i> 3. Upload Vật Liệu</h3>
                <button class="upload-btn secondary" id="uploadTextureBtn">
                    <i class="fas fa-images"></i> Chọn Ảnh Vật Liệu
                </button>
                <input type="file" id="textureFiles" accept="image/*" multiple hidden>
                
                <p style="margin: 15px 0 10px; color: #ccc;">Kéo thả vào canvas:</p>
                <div class="thumbnails" id="textureThumbnails"></div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-tools"></i> 4. Công Cụ Chỉnh Sửa</h3>
                <div class="tools">
                    <button class="tool-btn active-tool" id="transformBtn" title="Chọn & Chỉnh sửa (Ctrl+T / Esc)">
                        <i class="fas fa-mouse-pointer"></i>
                        <span>Select</span>
                    </button>
                    
                    <button class="tool-btn" id="handToolBtn" title="Kéo Canvas (H)">
                        <i class="fas fa-hand-paper"></i>
                        <span>Bàn Tay</span>
                    </button> 
                    
                    <button class="tool-btn" id="drawBtn" title="Vẽ tự do (D)">
                        <i class="fas fa-pencil-alt"></i>
                        <span>Vẽ Tự Do</span>
                    </button>
                    
                    <button class="tool-btn" id="lassoBtn" title="Công cụ Laso (L)">
                        <i class="fas fa-cut"></i>
                        <span>Laso Tool</span>
                    </button>
                    
                    <button class="tool-btn" id="fitSurfaceBtn">
                        <i class="fas fa-crop-alt"></i>
                        <span>Fit Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="warpAutoBtn" title="Warp tự động (W)">
                        <i class="fas fa-wave-square"></i>
                        <span>Warp Auto</span>
                    </button>
                    <button class="tool-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                    <button class="tool-btn" id="bringFrontBtn">
                        <i class="fas fa-arrow-up"></i>
                        <span>Lên Trước</span>
                    </button>
                    <button class="tool-btn" id="sendBackBtn">
                        <i class="fas fa-arrow-down"></i>
                        <span>Ra Sau</span>
                    </button>
                    <button class="tool-btn" id="zoomInBtn" title="Zoom In (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom In</span>
                    </button>
                    <button class="tool-btn" id="zoomOutBtn" title="Zoom Out (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-minus"></i>
                        <span>Zoom Out</span>
                    </button>
                    <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Reset Zoom</span>
                    </button>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-download"></i> 5. Lưu & Xuất File</h3>
                <button class="upload-btn save" id="saveBtn">
                    <i class="fas fa-save"></i> Lưu & Xuất Ảnh
                </button>
                <div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Hỗ trợ: PNG, JPG (Chất lượng cao)
                </div>
            </div>

        </div>

        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
                
                <div class="drawing-controls" id="drawingControls" style="display: none;">
                    <div class="drawing-control">
                        <label>Màu vẽ:</label>
                        <input type="color" id="drawingColor" value="#4ecdc4" class="drawing-color-picker">
                    </div>
                    <div class="drawing-control">
                        <label>Độ rộng:</label>
                        <input type="range" id="drawingWidth" min="1" max="50" value="5">
                        <span id="drawingWidthValue" style="color: white; min-width: 20px;">5px</span>
                    </div>
                    <div class="drawing-control">
                        <label>Độ mờ:</label>
                        <input type="range" id="drawingOpacity" min="0" max="100" value="100">
                        <span id="drawingOpacityValue" style="color: white; min-width: 30px;">100%</span>
                    </div>
                    <button class="history-btn" id="clearDrawing" style="margin-top: 5px;">
                        <i class="fas fa-broom"></i> Xóa nét vẽ
                    </button>
                </div>
                
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInCanvas" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="zoom-display" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOutCanvas" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn zoom-reset" id="zoomResetCanvas" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Sử dụng <strong>Escape</strong> để chuyển về công cụ <strong>Select</strong></span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-cut"></i>
                    <span>Nhấn <strong>L</strong> để dùng Laso Tool, vẽ vùng và double-click để kết thúc</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-check-circle"></i>
                    <span>Nhấn <strong>W</strong> để Warp tự động, <strong>Hoàn Tất Tất Cả</strong> để xuất file</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVE MODAL -->
    <div class="overlay" id="saveOverlay"></div>
    <div class="warp-modal" id="saveModal" style="width: 400px;">
        <h3 class="save-header">
            <i class="fas fa-download"></i> Xuất file Mockup
        </h3>
        <div class="warp-controls" style="grid-template-columns: 1fr;">
            <div class="warp-control">
                <div class="control-label">Định dạng file</div>
                <select id="exportFormat" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
                    <option value="png">PNG (Chất lượng cao)</option>
                    <option value="jpeg">JPG (Kích thước nhỏ)</option>
                </select>
            </div>
            <div class="warp-control">
                <div class="control-label">Tên file</div>
                <input type="text" id="exportFileName" value="mockup_k_pro" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelSave">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="confirmSave">
                <i class="fas fa-download"></i> Tải xuống
            </button>
        </div>
    </div>

    <!-- DISPLACEMENT MAP CREATION MODAL -->
    <div class="overlay" id="dispCreationOverlay"></div>
    <div class="disp-creation-modal" id="dispCreationModal">
        <div class="modal-header">
            <h3 class="save-header">
                <i class="fas fa-robot"></i> Tạo Displacement Map Tự Động
            </h3>
            <button class="close-modal-btn" id="closeDispModal" title="Đóng">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <div class="tab-buttons">
            <button class="tab-btn active" data-tab="auto">Tự Động</button>
            <button class="tab-btn" data-tab="manual">Hướng Dẫn</button>
        </div>

        <!-- TAB 1: TỰ ĐỘNG -->
        <div class="tab-content active" id="tab-auto">
            <div class="disp-preview-container">
                <div class="disp-preview-box">
                    <h4>Mockup Gốc</h4>
                    <canvas id="originalPreview" class="disp-canvas"></canvas>
                </div>
                <div class="disp-preview-box">
                    <h4>Displacement Map (Kết quả)</h4>
                    <canvas id="dispPreview" class="disp-canvas"></canvas>
                </div>
            </div>

            <div class="disp-controls">
                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ tương phản</span>
                        <span class="disp-slider-value" id="contrastValue">50</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="warp-slider" id="contrastSlider">
                </div>

                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ sáng</span>
                        <span class="disp-slider-value" id="brightnessValue">50</span>
                    </div>
                    <input type="range" min="0" max="100" value="50" class="warp-slider" id="brightnessSlider">
                </div>

                <div class="disp-slider-group">
                    <div class="disp-slider-label">
                        <span>Độ mờ (Blur)</span>
                        <span class="disp-slider-value" id="blurValue">3</span>
                    </div>
                    <input type="range" min="0" max="20" value="3" class="warp-slider" id="blurSlider">
                </div>
            </div>

            <div class="disp-preset-buttons">
                <button class="disp-preset-btn active" data-preset="basic">Cơ bản</button>
                <button class="disp-preset-btn" data-preset="strong">Mạnh</button>
                <button class="disp-preset-btn" data-preset="soft">Mềm mại</button>
                <button class="disp-preset-btn" data-preset="edges">Chi tiết cạnh</button>
            </div>

            <div class="info-box">
                <h4><i class="fas fa-lightbulb"></i> Mẹo sử dụng:</h4>
                <ul>
                    <li><strong>Mockup có nếp gấp</strong>: Dùng preset "Chi tiết cạnh"</li>
                    <li><strong>Mockup cong mềm mại</strong>: Dùng preset "Mềm mại" + tăng Blur</li>
                    <li><strong>Vải/Áo thun</strong>: Tăng độ mờ để tạo cảm giác mềm</li>
                </ul>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelDisp">
                    <i class="fas fa-times"></i> Hủy
                </button>
                <button class="modal-btn primary" id="applyDisp">
                    <i class="fas fa-check"></i> Áp Dụng Map Này
                </button>
            </div>
        </div>

        <!-- TAB 2: HƯỚNG DẪN -->
        <div class="tab-content" id="tab-manual">
            <div class="info-box">
                <h4><i class="fas fa-graduation-cap"></i> Hướng dẫn tạo Displacement Map</h4>
                
                <h5>Phương pháp 1: Dùng Photopea (Online - Miễn phí)</h5>
                <ol>
                    <li>Mở <a href="https://www.photopea.com" target="_blank">Photopea.com</a></li>
                    <li>Upload mockup của bạn</li>
                    <li>Nhấn <strong>Ctrl+Shift+U</strong> để chuyển thành ảnh đen trắng</li>
                    <li>Nhấn <strong>Ctrl+L</strong> để mở Levels, điều chỉnh thanh trượt</li>
                    <li>Vào <strong>Filter → Blur → Gaussian Blur</strong> (2-5px)</li>
                    <li>File → Export as → PNG → Tải về</li>
                    <li>Quay lại app và Upload file vừa tải</li>
                </ol>

                <h5>Phương pháp 2: Dùng điện thoại</h5>
                <p>App miễn phí:</p>
                <ul>
                    <li><strong>Snapseed</strong> (Google): Chuyển đen trắng + chỉnh độ tương phản</li>
                    <li><strong>Adobe Photoshop Express</strong>: Có filter đen trắng chuyên nghiệp</li>
                </ul>
            </div>

            <div class="modal-buttons">
                <button class="modal-btn secondary" id="closeManual">
                    <i class="fas fa-times"></i> Đóng
                </button>
                <button class="modal-btn primary" onclick="window.open('https://www.photopea.com', '_blank')">
                    <i class="fas fa-external-link-alt"></i> Mở Photopea Ngay
                </button>
            </div>
        </div>
    </div>

    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-info-circle"></i>
            <span id="statusText">Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu</span>
        </div>
        <div class="status-item">
            <i class="fas fa-object-group"></i>
            <span>Đối tượng: <span id="selectedObj">Không có</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-expand-arrows-alt"></i>
            <span>Zoom: <span id="zoomStatus">100%</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-history"></i>
            <span>History: <span id="historyStatus">0/0</span></span>
        </div>
    </div>

    <script>
        // ========== KHỞI TẠO CANVAS FABRIC.JS ==========
        const canvas = new fabric.Canvas('main-canvas', {
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selection: true,
            selectionKey: 'shiftKey'
        });

        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ========== BIẾN TOÀN CỤC ==========
        let mockupImage = null;
        let displacementMap = null; 
        let textures = [];
        let zoomLevel = 1;
        let currentToolMode = 'select';
        
        let drawingBrush = {
            color: '#4ecdc4',
            width: 5,
            opacity: 1.0
        };
        
        // ========== BIẾN CHO CÔNG CỤ LASO CẢI TIẾN ==========
        let isLassoMode = false;
        let lassoPoints = [];
        let lassoPath = null;
        let isDrawingLasso = false;
        
        // ========== UNDO/REDO SYSTEM ==========
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        
        function saveToHistory() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const state = canvas.toDatalessJSON(['globalCompositeOperation']);
            history.push(state);
            historyIndex++;
            
            if (history.length > MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
            updateHistoryStatus();
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        function updateHistoryStatus() {
            document.getElementById('historyStatus').textContent = 
                `${historyIndex}/${history.length-1}`;
        }
        
        canvas.on('object:modified', saveToHistory);
        canvas.on('object:added', saveToHistory);
        canvas.on('object:removed', saveToHistory);

        // ========== CÔNG CỤ VẼ TỰ DO ==========
        function activateDrawingMode() {
            currentToolMode = 'draw';
            canvas.isDrawingMode = true;
            canvas.selection = false;
            
            canvas.freeDrawingBrush = new fabric.PencilBrush(canvas);
            canvas.freeDrawingBrush.color = drawingBrush.color;
            canvas.freeDrawingBrush.width = drawingBrush.width;
            canvas.freeDrawingBrush.opacity = drawingBrush.opacity;
            
            document.getElementById('drawingControls').style.display = 'flex';
            updateToolButtons();
            updateStatus('Chế độ vẽ tự do - Kéo chuột để vẽ');
        }
        
        function deactivateDrawingMode() {
            canvas.isDrawingMode = false;
            canvas.selection = true;
            document.getElementById('drawingControls').style.display = 'none';
        }
        
        document.getElementById('drawBtn').addEventListener('click', function() {
            if (currentToolMode === 'draw') {
                setToolMode('select');
            } else {
                setToolMode('draw');
            }
        });
        
        document.getElementById('drawingColor').addEventListener('input', function(e) {
            drawingBrush.color = e.target.value;
            if (currentToolMode === 'draw') {
                canvas.freeDrawingBrush.color = drawingBrush.color;
            }
            e.target.style.background = drawingBrush.color;
        });
        
        document.getElementById('drawingWidth').addEventListener('input', function(e) {
            drawingBrush.width = parseInt(e.target.value);
            document.getElementById('drawingWidthValue').textContent = drawingBrush.width + 'px';
            
            if (currentToolMode === 'draw') {
                canvas.freeDrawingBrush.width = drawingBrush.width;
            }
        });
        
        document.getElementById('drawingOpacity').addEventListener('input', function(e) {
            drawingBrush.opacity = parseInt(e.target.value) / 100;
            document.getElementById('drawingOpacityValue').textContent = e.target.value + '%';
            
            if (currentToolMode === 'draw') {
                canvas.freeDrawingBrush.opacity = drawingBrush.opacity;
            }
        });
        
        document.getElementById('clearDrawing').addEventListener('click', function() {
            const drawingObjects = canvas.getObjects().filter(obj => 
                obj.type === 'path' && obj.name === 'free_drawing'
            );
            
            drawingObjects.forEach(obj => {
                canvas.remove(obj);
            });
            
            canvas.renderAll();
            saveToHistory();
            updateStatus('Đã xóa tất cả nét vẽ');
        });
        
        canvas.on('path:created', function(e) {
            e.path.name = 'free_drawing';
            saveToHistory();
        });

        // ========== CÔNG CỤ LASO CẢI TIẾN ==========
        function activateLassoMode() {
            currentToolMode = 'lasso';
            isLassoMode = true;
            isDrawingLasso = false;
            lassoPoints = [];
            
            canvas.selection = false;
            canvas.defaultCursor = 'crosshair';
            canvas.hoverCursor = 'crosshair';
            
            updateToolButtons();
            updateStatus('Laso Tool: Click và kéo để vẽ vùng chọn, Double-click để kết thúc');
        }

        function startLassoDrawing(event) {
            if (!isLassoMode) return;
            
            isDrawingLasso = true;
            const pointer = canvas.getPointer(event.e);
            
            lassoPoints = [{x: pointer.x, y: pointer.y}];
            
            // Tạo path mới
            lassoPath = new fabric.Path(`M ${pointer.x} ${pointer.y}`, {
                fill: 'rgba(255, 0, 0, 0.2)',
                stroke: '#ff0000',
                strokeWidth: 2,
                selectable: false,
                evented: false
            });
            
            canvas.add(lassoPath);
        }

        function continueLassoDrawing(event) {
            if (!isLassoMode || !isDrawingLasso) return;
            
            const pointer = canvas.getPointer(event.e);
            lassoPoints.push({x: pointer.x, y: pointer.y});
            
            // Cập nhật path với đường cong mượt
            let pathString = `M ${lassoPoints[0].x} ${lassoPoints[0].y}`;
            
            for (let i = 1; i < lassoPoints.length; i++) {
                // Sử dụng đường cong quadratic để mượt hơn
                const prevPoint = lassoPoints[i-1];
                const currentPoint = lassoPoints[i];
                const controlX = (prevPoint.x + currentPoint.x) / 2;
                const controlY = (prevPoint.y + currentPoint.y) / 2;
                
                pathString += ` Q ${prevPoint.x} ${prevPoint.y} ${controlX} ${controlY}`;
            }
            
            lassoPath.set({ path: pathString });
            canvas.renderAll();
        }

        function endLassoDrawing(event) {
            if (!isLassoMode || !isDrawingLasso) return;
            
            if (event.e.detail === 2) { // Double-click
                finishLassoSelection();
            }
        }

        function finishLassoSelection() {
            if (lassoPoints.length < 3) return;
            
            // Đóng path bằng cách nối điểm cuối với điểm đầu
            const firstPoint = lassoPoints[0];
            const lastPoint = lassoPoints[lassoPoints.length - 1];
            
            let pathString = lassoPath.path.join(' ');
            pathString += ` L ${firstPoint.x} ${firstPoint.y} Z`;
            
            lassoPath.set({ 
                path: pathString,
                fill: 'rgba(255, 0, 0, 0.3)'
            });
            
            canvas.renderAll();
            isDrawingLasso = false;
            
            updateStatus('Đã tạo vùng chọn. Nhấn Delete để xóa phần bên trong vùng này.');
        }

        function deleteLassoArea() {
            if (!isLassoMode || !lassoPath || lassoPoints.length < 3) {
                updateStatus('Vui lòng tạo vùng chọn trước khi xóa');
                return;
            }
            
            const activeObj = canvas.getActiveObject();
            if (!activeObj || activeObj.name !== 'texture') {
                updateStatus('Không tìm thấy vật liệu để xóa');
                return;
            }
            
            // Tạo một canvas ẩn để xử lý
            const tempCanvas = document.createElement('canvas');
            const ctx = tempCanvas.getContext('2d');
            
            // Lấy kích thước texture
            const img = activeObj.getElement();
            tempCanvas.width = img.width;
            tempCanvas.height = img.height;
            
            // Vẽ texture gốc
            ctx.drawImage(img, 0, 0);
            
            // Tạo path từ các điểm lasso (chuyển đổi tọa độ)
            ctx.beginPath();
            
            // Chuyển đổi tọa độ từ canvas sang image
            const matrix = activeObj.calcTransformMatrix();
            const invertedMatrix = fabric.util.invertTransform(matrix);
            
            // Điểm đầu tiên
            const firstTransformed = fabric.util.transformPoint(
                new fabric.Point(lassoPoints[0].x, lassoPoints[0].y),
                invertedMatrix
            );
            ctx.moveTo(firstTransformed.x, firstTransformed.y);
            
            // Vẽ đường cong qua các điểm
            for (let i = 1; i < lassoPoints.length; i++) {
                const prevTransformed = fabric.util.transformPoint(
                    new fabric.Point(lassoPoints[i-1].x, lassoPoints[i-1].y),
                    invertedMatrix
                );
                const currentTransformed = fabric.util.transformPoint(
                    new fabric.Point(lassoPoints[i].x, lassoPoints[i].y),
                    invertedMatrix
                );
                
                const controlX = (prevTransformed.x + currentTransformed.x) / 2;
                const controlY = (prevTransformed.y + currentTransformed.y) / 2;
                
                ctx.quadraticCurveTo(
                    prevTransformed.x, prevTransformed.y,
                    controlX, controlY
                );
            }
            
            // Đóng path
            ctx.closePath();
            
            // Xóa phần bên trong path
            ctx.globalCompositeOperation = 'destination-out';
            ctx.fill();
            
            // Tạo ảnh mới
            fabric.Image.fromURL(tempCanvas.toDataURL(), function(newImg) {
                newImg.set({
                    left: activeObj.left,
                    top: activeObj.top,
                    scaleX: activeObj.scaleX,
                    scaleY: activeObj.scaleY,
                    angle: activeObj.angle,
                    opacity: activeObj.opacity,
                    hasControls: true,
                    hasBorders: true,
                    cornerStyle: 'circle',
                    cornerColor: '#4ecdc4',
                    borderColor: '#4ecdc4',
                    cornerSize: 12,
                    transparentCorners: false,
                    name: 'texture'
                });
                
                canvas.remove(activeObj);
                canvas.add(newImg);
                canvas.setActiveObject(newImg);
                
                // Dọn dẹp lasso
                cleanupLasso();
                
                canvas.renderAll();
                saveToHistory();
                updateStatus('Đã xóa phần bên trong vùng chọn thành công!');
            });
        }

        function cleanupLasso() {
            if (lassoPath) {
                canvas.remove(lassoPath);
                lassoPath = null;
            }
            
            lassoPoints = [];
            isDrawingLasso = false;
            
            canvas.defaultCursor = 'default';
            canvas.hoverCursor = 'move';
        }

        // ========== WARP TỰ ĐỘNG ==========
        function applyAutoWarp() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || activeObj.name !== 'texture') {
                updateStatus('Vui lòng chọn một vật liệu để warp tự động');
                return;
            }
            
            // Kiểm tra nếu có displacement map
            if (!displacementMap) {
                updateStatus('Đang tạo displacement map tự động...');
                createAutoDisplacementMap().then(() => {
                    applyWarpWithSettings(activeObj, {
                        dispIntensity: 40,
                        warpX: 5,
                        warpY: 5,
                        bulge: 15,
                        pinch: 0,
                        wave: 0,
                        blend: 60
                    });
                });
            } else {
                applyWarpWithSettings(activeObj, {
                    dispIntensity: 40,
                    warpX: 5,
                    warpY: 5,
                    bulge: 15,
                    pinch: 0,
                    wave: 0,
                    blend: 60
                });
            }
        }

        function createAutoDisplacementMap() {
            return new Promise((resolve, reject) => {
                if (!mockupImage) {
                    reject(new Error('Chưa có mockup'));
                    return;
                }
                
                const mockupElement = mockupImage.getElement();
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                
                tempCanvas.width = 400;
                tempCanvas.height = 300;
                
                ctx.drawImage(mockupElement, 0, 0, tempCanvas.width, tempCanvas.height);
                
                // Chuyển sang đen trắng và tăng độ tương phản
                const imageData = ctx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                const data = imageData.data;
                
                for (let i = 0; i < data.length; i += 4) {
                    const r = data[i];
                    const g = data[i + 1];
                    const b = data[i + 2];
                    
                    // Tính luminance và tăng tương phản
                    let luminance = 0.299 * r + 0.587 * g + 0.114 * b;
                    luminance = (luminance - 128) * 1.5 + 128;
                    luminance = Math.max(0, Math.min(255, luminance));
                    
                    data[i] = luminance;
                    data[i + 1] = luminance;
                    data[i + 2] = luminance;
                }
                
                ctx.putImageData(imageData, 0, 0);
                
                // Áp dụng blur nhẹ
                ctx.filter = 'blur(3px)';
                ctx.drawImage(tempCanvas, 0, 0);
                ctx.filter = 'none';
                
                // Tạo displacement map
                const img = new Image();
                img.onload = function() {
                    displacementMap = img;
                    updateStatus('Đã tạo Displacement Map tự động');
                    resolve();
                };
                img.src = tempCanvas.toDataURL();
            });
        }

        function applyWarpWithSettings(obj, settings) {
            const imgElement = obj.getElement();
            
            try {
                const fxCanvas = fx.canvas();
                const texture = fxCanvas.texture(imgElement);
                
                fxCanvas.draw(texture).update();
                
                if (settings.dispIntensity > 0 && displacementMap) {
                    const displacementTexture = fxCanvas.texture(displacementMap);
                    fxCanvas.heightField(displacementTexture, settings.dispIntensity / 100 * 0.15).update();
                }
                
                const center = [0.5, 0.5];
                if (settings.bulge > 0) {
                    fxCanvas.bulgePinch(center[0], center[1], settings.bulge / 100 * 0.5, 0.9).update();
                }
                
                const warpedUrl = fxCanvas.toDataURL();
                
                fabric.Image.fromURL(warpedUrl, function(warpedImg) {
                    warpedImg.set({
                        left: obj.left,
                        top: obj.top,
                        scaleX: obj.scaleX,
                        scaleY: obj.scaleY,
                        angle: obj.angle,
                        skewX: obj.skewX + settings.warpX * 0.3,
                        skewY: obj.skewY + settings.warpY * 0.3,
                        globalCompositeOperation: 'multiply',
                        opacity: Math.max(0.7, 1 - (1 - settings.blend/100) * 0.3),
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false,
                        name: 'texture'
                    });
                    
                    canvas.remove(obj);
                    canvas.add(warpedImg);
                    canvas.setActiveObject(warpedImg);
                    canvas.renderAll();
                    saveToHistory();
                    updateStatus('Đã áp dụng warp tự động thành công!');
                });
            } catch (e) {
                updateStatus('Lỗi Warp: Vui lòng kiểm tra console.');
                console.error('Warp Error:', e);
            }
        }

        // ========== CHUYỂN ĐỔI CÔNG CỤ ==========
        function setToolMode(mode) {
            // Dọn dẹp mode cũ
            if (currentToolMode === 'draw') {
                deactivateDrawingMode();
            } else if (currentToolMode === 'lasso') {
                cleanupLasso();
                canvas.off('mouse:down');
                canvas.off('mouse:move');
                canvas.off('mouse:up');
            }
            
            currentToolMode = mode;
            
            document.querySelectorAll('.tools .tool-btn').forEach(btn => {
                btn.classList.remove('active-tool');
            });

            if (mode === 'hand') {
                document.getElementById('handToolBtn').classList.add('active-tool');
                canvas.selection = false;
                canvas.defaultCursor = 'grab';
                canvas.hoverCursor = 'grab';
                updateStatus('Chế độ Bàn Tay (Pan) được kích hoạt');
            } else if (mode === 'draw') {
                document.getElementById('drawBtn').classList.add('active-tool');
                activateDrawingMode();
            } else if (mode === 'lasso') {
                document.getElementById('lassoBtn').classList.add('active-tool');
                activateLassoMode();
                
                // Thiết lập sự kiện cho laso
                canvas.on('mouse:down', startLassoDrawing);
                canvas.on('mouse:move', continueLassoDrawing);
                canvas.on('mouse:up', endLassoDrawing);
            } else {
                document.getElementById('transformBtn').classList.add('active-tool');
                canvas.selection = true;
                canvas.defaultCursor = 'default';
                canvas.hoverCursor = 'move';
                updateStatus('Chế độ Select/Transform được kích hoạt');
            }
            canvas.renderAll();
        }

        document.getElementById('handToolBtn').addEventListener('click', () => setToolMode('hand'));
        document.getElementById('transformBtn').addEventListener('click', () => setToolMode('select'));
        document.getElementById('lassoBtn').addEventListener('click', function() {
            if (currentToolMode === 'lasso') {
                setToolMode('select');
            } else {
                setToolMode('lasso');
            }
        });
        document.getElementById('warpAutoBtn').addEventListener('click', applyAutoWarp);

        // ========== ZOOM & PAN ==========
        let isPanning = false;

        canvas.on('mouse:down', function(opt) {
            const evt = opt.e;
            if (currentToolMode === 'draw' || currentToolMode === 'lasso') {
                return;
            }
            
            if (evt.ctrlKey || evt.altKey || currentToolMode === 'hand') { 
                isPanning = true;
                canvas.selection = false; 
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.clientY;
                if (currentToolMode === 'hand') {
                    canvas.defaultCursor = 'grabbing';
                }
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (isPanning && zoomLevel >= 1) {
                const evt = opt.e;
                const vpt = canvas.viewportTransform;
                
                vpt[4] += evt.clientX - canvas.lastPosX;
                vpt[5] += evt.clientY - canvas.lastPosY;
                
                limitPan(vpt);
                canvas.requestRenderAll();
                
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.lastPosY = evt.clientY;
            }
        });

        canvas.on('mouse:up', function(opt) {
            isPanning = false;
            if (currentToolMode === 'select') {
                canvas.selection = true;
                canvas.defaultCursor = 'default';
            } else if (currentToolMode === 'hand') {
                 canvas.defaultCursor = 'grab';
                 canvas.selection = false; 
            }
            canvas.setViewportTransform(canvas.viewportTransform); 
        });

        function limitPan(vpt) {
            const viewportWidth = canvas.getWidth();
            const viewportHeight = canvas.getHeight();
            const maxOffsetX = viewportWidth * (zoomLevel - 1) * 0.5;
            const maxOffsetY = viewportHeight * (zoomLevel - 1) * 0.5;

            if (vpt[4] > maxOffsetX) vpt[4] = maxOffsetX;
            if (vpt[4] < -maxOffsetX) vpt[4] = -maxOffsetX;
            if (vpt[5] > maxOffsetY) vpt[5] = maxOffsetY;
            if (vpt[5] < -maxOffsetY) vpt[5] = -maxOffsetY;
        }

        canvas.on('mouse:wheel', function(opt) {
            const delta = opt.e.deltaY;
            let newZoom = zoomLevel;

            if (delta > 0) newZoom /= 1.1;
            else if (delta < 0) newZoom *= 1.1;

            newZoom = Math.min(5, Math.max(0.1, newZoom));
            
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, newZoom);
            zoomLevel = newZoom;
            
            limitPan(canvas.viewportTransform);
            updateZoomDisplay();
            opt.e.preventDefault(); 
            opt.e.stopPropagation();
        });

        function updateZoomDisplay() {
            const percent = Math.round(zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomStatus').textContent = percent + '%';
            canvas.renderAll();
        }
        
        function zoomToPoint(point, newZoom) {
            zoomLevel = Math.min(5, Math.max(0.1, newZoom));
            canvas.zoomToPoint(point, zoomLevel);
            updateZoomDisplay();
        }
        
        function resetZoom() { 
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            zoomLevel = 1;
            canvas.setZoom(1);
            updateZoomDisplay();
            updateStatus("Zoom đã reset về 100%"); 
        }

        document.getElementById('zoomInCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 1.2));
        document.getElementById('zoomOutCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 0.8));
        document.getElementById('zoomResetCanvas').addEventListener('click', resetZoom);

        // ========== UPLOAD FUNCTIONS ==========
        document.getElementById('uploadMockupBtn').addEventListener('click', function() {
            document.getElementById('mockupFile').click();
        });

        document.getElementById('mockupFile').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (mockupImage) canvas.remove(mockupImage);
                    
                    fabric.Image.fromURL(event.target.result, function(img) {
                        mockupImage = img;
                        mockupImage.set({ 
                            selectable: false, 
                            evented: false, 
                            hasControls: false, 
                            hasBorders: false, 
                            name: 'mockup_bg' 
                        });
                        
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
                        
                        img.scale(scale);
                        img.set({
                            left: (canvas.width - img.width * scale) / 2,
                            top: (canvas.height - img.height * scale) / 2
                        });
                        
                        canvas.add(img);
                        canvas.sendToBack(img);
                        updateStatus('Mockup đã được tải lên!');
                        saveToHistory();
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        document.getElementById('uploadTextureBtn').addEventListener('click', function() {
            document.getElementById('textureFiles').click();
        });

        document.getElementById('textureFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const thumbnailsContainer = document.getElementById('textureThumbnails');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    textures.push({
                        id: Date.now() + index,
                        url: event.target.result,
                        name: file.name
                    });
                    
                    const thumbnail = document.createElement('img');
                    thumbnail.src = event.target.result;
                    thumbnail.className = 'thumbnail';
                    thumbnail.draggable = true;
                    thumbnail.dataset.index = textures.length - 1;
                    
                    thumbnail.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('textureIndex', this.dataset.index);
                    });
                    thumbnailsContainer.appendChild(thumbnail);
                };
                reader.readAsDataURL(file);
            });
            updateStatus(`Đã tải lên ${files.length} ảnh vật liệu`);
        });

        canvas.on('drop', function(event) {
            if (currentToolMode === 'draw' || currentToolMode === 'lasso') {
                return;
            }
            
            event.e.preventDefault();
            
            const textureIndex = event.e.dataTransfer.getData('textureIndex');
            if (textureIndex === '') return;
            
            const index = parseInt(textureIndex);
            if (textures[index]) {
                const texture = textures[index];
                
                fabric.Image.fromURL(texture.url, function(img) {
                    const scale = 200 / Math.max(img.width, img.height);
                    
                    img.set({
                        left: event.e.offsetX - (img.width * scale) / 2,
                        top: event.e.offsetY - (img.height * scale) / 2,
                        scaleX: scale,
                        scaleY: scale,
                        globalCompositeOperation: 'multiply', 
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false,
                        name: 'texture' 
                    });
                    
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    updateStatus(`Đã thêm "${texture.name}" vào mockup`);
                    updateSelectedObject();
                    saveToHistory();
                });
            }
        });

        canvas.on('dragover', function(event) { 
            event.e.preventDefault(); 
        });
        
        // ========== FIT BỀ MẶT ==========
        document.getElementById('fitSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và vật liệu để fit bề mặt');
                return;
            }
            
            const mockupBounds = mockupImage.getBoundingRect();
            const fitScale = 0.8;
            
            const targetWidth = mockupBounds.width * fitScale;
            const targetHeight = mockupBounds.height * fitScale;
            
            const scaleX = targetWidth / activeObj.width;
            const scaleY = targetHeight / activeObj.height;
            const scale = Math.min(scaleX, scaleY);
            
            activeObj.set({
                scaleX: scale,
                scaleY: scale,
                left: mockupBounds.left + (mockupBounds.width - activeObj.width * scale) / 2,
                top: mockupBounds.top + (mockupBounds.height - activeObj.height * scale) / 2,
                angle: 0,
                skewX: 0,
                skewY: 0,
                opacity: 0.9,
                globalCompositeOperation: 'multiply'
            });
            
            activeObj.setCoords();
            canvas.renderAll();
            updateStatus('Đã fit ảnh theo bề mặt mockup');
            saveToHistory();
        });

        // ========== HOÀN TẤT TẤT CẢ ==========
        document.getElementById('finishAllBtn').addEventListener('click', async function() {
            updateStatus('Đang xử lý hoàn tất tất cả...');
            
            try {
                // 1. Tạo displacement map nếu chưa có
                if (!displacementMap && mockupImage) {
                    updateStatus('Đang tạo Displacement Map...');
                    await createAutoDisplacementMap();
                }
                
                // 2. Áp dụng warp cho tất cả vật liệu
                const textureObjects = canvas.getObjects().filter(obj => obj.name === 'texture');
                
                if (textureObjects.length > 0) {
                    updateStatus(`Đang áp dụng warp cho ${textureObjects.length} vật liệu...`);
                    
                    for (const texture of textureObjects) {
                        canvas.setActiveObject(texture);
                        applyWarpWithSettings(texture, {
                            dispIntensity: 40,
                            warpX: 5,
                            warpY: 5,
                            bulge: 15,
                            pinch: 0,
                            wave: 0,
                            blend: 60
                        });
                    }
                }
                
                // 3. Mở modal save sau 1 giây
                setTimeout(() => {
                    document.getElementById('saveModal').classList.add('active');
                    document.getElementById('saveOverlay').classList.add('active');
                    updateStatus('Hoàn tất! Vui lòng đặt tên file và tải xuống.');
                }, 1000);
                
            } catch (error) {
                updateStatus('Lỗi khi hoàn tất: ' + error.message);
                console.error(error);
            }
        });

        // ========== LƯU/XUẤT FILE ==========
        const saveModal = document.getElementById('saveModal');
        const saveOverlay = document.getElementById('saveOverlay');
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            saveModal.classList.add('active');
            saveOverlay.classList.add('active');
            updateStatus('Mở hộp thoại xuất file');
        });

        document.getElementById('cancelSave').addEventListener('click', closeSaveModal);
        saveOverlay.addEventListener('click', closeSaveModal);

        function closeSaveModal() {
            saveModal.classList.remove('active');
            saveOverlay.classList.remove('active');
        }

        document.getElementById('confirmSave').addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const fileName = document.getElementById('exportFileName').value || 'mockup_k_pro';
            
            updateStatus('Đang tạo hình ảnh xuất file, vui lòng chờ...');
            
            const originalVpt = [...canvas.viewportTransform];
            const originalZoom = zoomLevel;
            
            canvas.discardActiveObject(); 
            
            canvas.getObjects().forEach(obj => {
                obj.hasControls = false;
                obj.hasBorders = false;
            });
            
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            canvas.setZoom(1);
            canvas.renderAll();

            const dataURL = canvas.toDataURL({
                format: format,
                quality: 0.95
            });

            setTimeout(() => {
                canvas.setViewportTransform(originalVpt);
                canvas.setZoom(originalZoom);
                zoomLevel = originalZoom;
                updateZoomDisplay();
                
                canvas.getObjects().forEach(obj => {
                    if (obj.name === 'texture') {
                        obj.hasControls = true;
                        obj.hasBorders = true;
                    }
                });
                canvas.renderAll();
                
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${fileName}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                updateStatus(`Đã xuất file ${fileName}.${format} thành công!`);
                closeSaveModal();

            }, 50); 
        });

        // ========== CÁC CÔNG CỤ KHÁC ==========
        document.getElementById('removeBtn').addEventListener('click', function() {
            if (currentToolMode === 'lasso' && lassoPath) {
                deleteLassoArea();
            } else {
                const activeObj = canvas.getActiveObject();
                if (activeObj && activeObj !== mockupImage) {
                    canvas.remove(activeObj);
                    updateStatus('Đã xóa đối tượng');
                    updateSelectedObject();
                    saveToHistory();
                }
            }
        });

        document.getElementById('bringFrontBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.bringToFront();
                canvas.renderAll();
                updateStatus('Đã đưa lên lớp trên');
                saveToHistory();
            }
        });

        document.getElementById('sendBackBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                activeObj.sendToBack();
                if (mockupImage) mockupImage.sendToBack();
                canvas.renderAll();
                updateStatus('Đã đưa xuống lớp dưới');
                saveToHistory();
            }
        });

        document.getElementById('undoBtn').addEventListener('click', function() {
             if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã undo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });
        document.getElementById('redoBtn').addEventListener('click', function() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã redo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });

        // ========== PHÍM TẮT ==========
        document.addEventListener('keydown', function(e) {
            if (e.key.toLowerCase() === 'h' && currentToolMode !== 'hand') { 
                e.preventDefault(); 
                setToolMode('hand');
            } else if (e.key === 'Escape' || (e.ctrlKey && e.key === 't')) { 
                e.preventDefault(); 
                setToolMode('select');
            } else if (e.key.toLowerCase() === 'd') { 
                e.preventDefault(); 
                if (currentToolMode === 'draw') {
                    setToolMode('select');
                } else {
                    setToolMode('draw');
                }
            } else if (e.key.toLowerCase() === 'l') { 
                e.preventDefault(); 
                if (currentToolMode === 'lasso') {
                    setToolMode('select');
                } else {
                    setToolMode('lasso');
                }
            } else if (e.key.toLowerCase() === 'w') { 
                e.preventDefault(); 
                applyAutoWarp();
            } else if (e.ctrlKey && e.key === 'z') { 
                e.preventDefault(); 
                document.getElementById('undoBtn').click(); 
            } else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) { 
                e.preventDefault(); 
                document.getElementById('redoBtn').click(); 
            } else if (e.key === 'Delete' || e.key === 'Backspace') {
                e.preventDefault(); 
                document.getElementById('removeBtn').click(); 
            }
        });

        canvas.on('selection:created', updateSelectedObject);
        canvas.on('selection:updated', updateSelectedObject);
        canvas.on('selection:cleared', updateSelectedObject);

        function updateSelectedObject() {
            const activeObj = canvas.getActiveObject();
            const selectedObjElement = document.getElementById('selectedObj');
            
            if (activeObj && activeObj !== mockupImage) {
                selectedObjElement.textContent = activeObj.name === 'texture' ? 'Vật Liệu' : 'Đã chọn';
                selectedObjElement.style.color = '#4ecdc4';
            } else {
                selectedObjElement.textContent = 'Không có';
                selectedObjElement.style.color = '#ff6b6b';
            }
        }
        
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }

        // ========== KHỞI TẠO ==========
        function updateToolButtons() {
            document.querySelectorAll('.tools .tool-btn').forEach(btn => {
                btn.classList.remove('active-tool');
            });
            
            if (currentToolMode === 'hand') {
                document.getElementById('handToolBtn').classList.add('active-tool');
            } else if (currentToolMode === 'draw') {
                document.getElementById('drawBtn').classList.add('active-tool');
            } else if (currentToolMode === 'lasso') {
                document.getElementById('lassoBtn').classList.add('active-tool');
            } else {
                document.getElementById('transformBtn').classList.add('active-tool');
            }
        }
        
        setToolMode('select');
        updateZoomDisplay();
        updateStatus('Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu');
        updateSelectedObject();
        updateHistoryButtons();
        updateHistoryStatus();
        
        document.getElementById('drawingColor').style.background = drawingBrush.color;
        
        setTimeout(() => {
            saveToHistory();
        }, 100);
    </script>
</body>
</html>
