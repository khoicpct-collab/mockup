<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <!-- Fabric.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <!-- CamanJS for color adjustment -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for image export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
            overflow-x: hidden;
        }

        /* HEADER với tiêu đề 3D */
        .header {
            text-align: center;
            margin-bottom: 25px;
            padding: 20px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .title {
            font-size: 4.5em;
            font-weight: 900;
            letter-spacing: 3px;
            background: linear-gradient(90deg, #ff0000, #ff6b6b, #4ecdc4, #00b4db);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            text-shadow: 
                3px 3px 0 #000,
                6px 6px 10px rgba(0, 0, 0, 0.5),
                0 0 30px rgba(0, 180, 219, 0.3);
            margin-bottom: 10px;
            text-transform: uppercase;
        }

        .subtitle {
            color: #a0a0c0;
            font-size: 1.2em;
        }

        /* LAYOUT CHÍNH */
        .container {
            display: flex;
            gap: 25px;
            height: 75vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 350px;
            background: rgba(25, 25, 45, 0.9);
            border-radius: 15px;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            overflow-y: auto;
        }

        .section {
            background: rgba(40, 40, 70, 0.7);
            padding: 20px;
            border-radius: 12px;
            border-left: 5px solid #4ecdc4;
            transition: transform 0.3s;
        }

        .section:hover {
            transform: translateY(-2px);
        }

        .section-title {
            color: #4ecdc4;
            margin-bottom: 15px;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .section-title i {
            font-size: 1.2em;
        }

        /* UPLOAD BUTTONS */
        .upload-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
            transition: all 0.3s ease;
            margin-bottom: 12px;
        }

        .upload-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(102, 126, 234, 0.5);
        }

        .upload-btn.secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .upload-btn.secondary:hover {
            box-shadow: 0 7px 15px rgba(245, 87, 108, 0.5);
        }

        .upload-btn.save {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
        }

        .upload-btn.save:hover {
            box-shadow: 0 7px 15px rgba(0, 176, 155, 0.5);
        }

        /* THUMBNAILS */
        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            max-height: 150px;
            overflow-y: auto;
            padding: 5px;
        }

        .thumbnail {
            width: 70px;
            height: 70px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid transparent;
            cursor: move;
            transition: all 0.3s;
        }

        .thumbnail:hover {
            border-color: #4ecdc4;
            transform: scale(1.05);
        }

        .thumbnail.active {
            border-color: #ff6b6b;
            box-shadow: 0 0 15px rgba(255, 107, 107, 0.6);
        }

        /* TOOL BUTTONS */
        .tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 15px;
        }

        .tool-btn {
            padding: 12px 8px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .tool-btn:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }

        .tool-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 10px rgba(102, 126, 234, 0.4);
        }

        .tool-btn i {
            font-size: 1.3em;
        }

        /* CANVAS AREA */
        .canvas-area {
            flex: 1;
            background: rgba(20, 20, 35, 0.9);
            border-radius: 15px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        .canvas-container {
            flex: 1;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            overflow: hidden;
            position: relative;
            border: 2px dashed rgba(255, 255, 255, 0.15);
        }

        #main-canvas {
            width: 100%;
            height: 100%;
            cursor: default;
        }

        /* ZOOM CONTROLS - ĐÃ CHỈNH SỬA */
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .zoom-btn {
            width: 40px;
            height: 40px;
            background: rgba(78, 205, 196, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .zoom-btn:hover {
            background: #4ecdc4;
            transform: scale(1.1);
        }

        .zoom-reset {
            background: rgba(255, 107, 107, 0.8);
        }

        .zoom-reset:hover {
            background: #ff6b6b;
        }

        .zoom-display {
            color: white;
            font-weight: bold;
            display: flex;
            align-items: center;
            padding: 0 10px;
            min-width: 60px;
            justify-content: center;
        }

        /* UNDO/REDO CONTROLS - MỚI */
        .history-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 25px;
            padding: 10px;
            display: flex;
            gap: 10px;
            z-index: 100;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .history-btn {
            width: 40px;
            height: 40px;
            background: rgba(102, 126, 234, 0.8);
            border: none;
            border-radius: 50%;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .history-btn:hover {
            background: #667eea;
            transform: scale(1.1);
        }

        .history-btn:disabled {
            background: rgba(60, 60, 100, 0.5);
            cursor: not-allowed;
            transform: none;
        }

        /* CANVAS INFO */
        .canvas-info {
            margin-top: 15px;
            text-align: center;
            color: #a0a0c0;
            font-size: 0.9em;
            display: flex;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .canvas-info-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* SAVE OPTIONS */
        .save-options {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            padding: 25px;
            border-radius: 15px;
            z-index: 1000;
            width: 400px;
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
        }

        .save-options.active {
            display: block;
        }

        .save-header {
            color: #4ecdc4;
            font-size: 1.5em;
            margin-bottom: 20px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .format-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .format-btn {
            padding: 15px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .format-btn:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }

        .format-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .format-btn i {
            font-size: 1.5em;
        }

        .quality-slider {
            width: 100%;
            margin: 15px 0;
        }

        .quality-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #00b09b 0%, #96c93d 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: rgba(255, 107, 107, 0.8);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }

        /* OVERLAY */
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .overlay.active {
            display: block;
        }

        /* STATUS BAR */
        .status-bar {
            background: rgba(0, 0, 0, 0.6);
            padding: 12px 25px;
            border-radius: 10px;
            margin-top: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.95em;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-item i {
            color: #4ecdc4;
        }

        /* RESPONSIVE */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            .sidebar {
                width: 100%;
            }
            .title {
                font-size: 3em;
            }
            .tools {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 768px) {
            .tools {
                grid-template-columns: repeat(3, 1fr);
            }
            .format-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
            .save-options {
                width: 90%;
            }
            .history-controls {
                top: 10px;
                right: 10px;
            }
            .zoom-controls {
                bottom: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- HEADER -->
    <div class="header">
        <h1 class="title">MOCKUP K</h1>
        <p class="subtitle">Professional Mockup Editor - Kéo thả, Chỉnh sửa, Xuất file</p>
    </div>

    <!-- MAIN CONTAINER -->
    <div class="container">
        <!-- SIDEBAR -->
        <div class="sidebar">
            <!-- UPLOAD MOCKUP -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> 1. Upload Mockup</h3>
                <button class="upload-btn" id="uploadMockupBtn">
                    <i class="fas fa-image"></i> Chọn Ảnh Mockup
                </button>
                <input type="file" id="mockupFile" accept="image/*" hidden>
            </div>

            <!-- UPLOAD VẬT LIỆU -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-layer-group"></i> 2. Upload Vật Liệu</h3>
                <button class="upload-btn secondary" id="uploadTextureBtn">
                    <i class="fas fa-images"></i> Chọn Ảnh Vật Liệu
                </button>
                <input type="file" id="textureFiles" accept="image/*" multiple hidden>
                
                <p style="margin: 15px 0 10px; color: #ccc;">Kéo thả vào canvas:</p>
                <div class="thumbnails" id="textureThumbnails">
                    <!-- Thumbnails sẽ hiện ở đây -->
                </div>
            </div>

            <!-- CÔNG CỤ CHỈNH SỬA -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-tools"></i> 3. Công Cụ Chỉnh Sửa</h3>
                <div class="tools">
                    <button class="tool-btn" id="transformBtn" title="Ctrl+T">
                        <i class="fas fa-expand-alt"></i>
                        <span>Transform</span>
                    </button>
                    <button class="tool-btn" id="fitSurfaceBtn">
                        <i class="fas fa-crop-alt"></i>
                        <span>Fit Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="warpSurfaceBtn">
                        <i class="fas fa-wave-square"></i>
                        <span>Warp Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="autoColorBtn">
                        <i class="fas fa-adjust"></i>
                        <span>Cân Màu</span>
                    </button>
                    <button class="tool-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                    <button class="tool-btn" id="bringFrontBtn">
                        <i class="fas fa-arrow-up"></i>
                        <span>Lên Trước</span>
                    </button>
                    <button class="tool-btn" id="sendBackBtn">
                        <i class="fas fa-arrow-down"></i>
                        <span>Ra Sau</span>
                    </button>
                    <button class="tool-btn" id="zoomInBtn" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom In</span>
                    </button>
                    <button class="tool-btn" id="zoomOutBtn" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                        <span>Zoom Out</span>
                    </button>
                    <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Reset Zoom</span>
                    </button>
                </div>
            </div>

            <!-- SAVE / EXPORT -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-download"></i> 4. Lưu & Xuất File</h3>
                <button class="upload-btn save" id="saveBtn">
                    <i class="fas fa-save"></i> Lưu & Xuất Ảnh
                </button>
                <div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Hỗ trợ: PNG, JPG, PDF
                </div>
            </div>

            <!-- HƯỚNG DẪN -->
            <div class="section">
                <h3 class="section-title"><i class="fas fa-info-circle"></i> Hướng Dẫn Nhanh</h3>
                <ul style="color: #ccc; padding-left: 20px; line-height: 1.6; font-size: 0.95em;">
                    <li><strong>1.</strong> Upload ảnh mockup trước</li>
                    <li><strong>2.</strong> Upload ảnh vật liệu (nhiều ảnh)</li>
                    <li><strong>3.</strong> Kéo thumbnail vào canvas</li>
                    <li><strong>4.</strong> Chọn ảnh → Transform (Ctrl+T)</li>
                    <li><strong>5.</strong> Dùng "Warp Bề Mặt" cho bề mặt cong</li>
                    <li><strong>6.</strong> Nhấn "Fit Bề Mặt" để tự căn</li>
                    <li><strong>7.</strong> Nhấn "Cân Màu" để đồng bộ</li>
                    <li><strong>8.</strong> Lưu file PNG/JPG/PDF</li>
                    <li><strong>9.</strong> Dùng Undo/Redo để quay lại</li>
                </ul>
            </div>
        </div>

        <!-- CANVAS AREA -->
        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
                
                <!-- UNDO/REDO CONTROLS - MỚI -->
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <!-- ZOOM CONTROLS - ĐÃ SỬA -->
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInCanvas" title="Zoom In (vào trung tâm)">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="zoom-display" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOutCanvas" title="Zoom Out (từ trung tâm)">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn zoom-reset" id="zoomResetCanvas" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Kéo thả ảnh từ sidebar</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-arrows-alt"></i>
                    <span>Kéo để di chuyển</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-search"></i>
                    <span>Scroll để zoom theo chuột</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-save"></i>
                    <span>Ctrl+S để lưu, Ctrl+Z/Y để Undo/Redo</span>
                </div>
            </div>
        </div>
    </div>

    <!-- SAVE MODAL -->
    <div class="overlay" id="saveOverlay"></div>
    <div class="save-options" id="saveModal">
        <h3 class="save-header">
            <i class="fas fa-download"></i> Xuất File
        </h3>
        
        <div class="format-buttons">
            <button class="format-btn active" data-format="png">
                <i class="fas fa-file-image"></i>
                <span>PNG</span>
                <small>Chất lượng cao</small>
            </button>
            <button class="format-btn" data-format="jpg">
                <i class="fas fa-file-image"></i>
                <span>JPG</span>
                <small>Kích thước nhỏ</small>
            </button>
            <button class="format-btn" data-format="pdf">
                <i class="fas fa-file-pdf"></i>
                <span>PDF</span>
                <small>In ấn</small>
            </button>
        </div>

        <div class="quality-label">
            <span>Chất lượng:</span>
            <span id="qualityValue">90%</span>
        </div>
        <input type="range" min="10" max="100" value="90" class="quality-slider" id="qualitySlider">

        <div class="quality-label">
            <span>Tên file:</span>
        </div>
        <input type="text" id="fileName" value="mockup-k-output" 
               style="width:100%; padding:10px; border-radius:8px; background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; margin-bottom:15px;">

        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelSave">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="confirmSave">
                <i class="fas fa-download"></i> Tải Xuống
            </button>
        </div>
    </div>

    <!-- STATUS BAR -->
    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-info-circle"></i>
            <span id="statusText">Sẵn sàng - Kéo thả ảnh để bắt đầu</span>
        </div>
        <div class="status-item">
            <i class="fas fa-object-group"></i>
            <span>Đối tượng: <span id="selectedObj">Không có</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-expand-arrows-alt"></i>
            <span>Zoom: <span id="zoomStatus">100%</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-history"></i>
            <span>History: <span id="historyStatus">0/0</span></span>
        </div>
    </div>

    <script>
        // ========== KHỞI TẠO CANVAS FABRIC.JS ==========
        const canvas = new fabric.Canvas('main-canvas', {
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selection: true,
            selectionKey: 'shiftKey'
        });

        // ========== ZOOM FUNCTIONALITY - ĐÃ SỬA ==========
        let zoomLevel = 1;
        const ZOOM_STEP = 0.2;
        const MIN_ZOOM = 0.1;
        const MAX_ZOOM = 5;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // Thiết lập kích thước canvas
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ========== BIẾN TOÀN CỤC ==========
        let mockupImage = null;
        let textures = [];
        let activeTextureIndex = -1;
        let currentFormat = 'png';
        let currentQuality = 0.9;
        
        // ========== UNDO/REDO SYSTEM - MỚI ==========
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        
        function saveToHistory() {
            // Xóa các state sau historyIndex nếu đang undo
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            // Lưu state hiện tại
            const state = canvas.toDatalessJSON();
            history.push(state);
            historyIndex++;
            
            // Giới hạn lịch sử
            if (history.length > MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
            updateHistoryStatus();
        }
        
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã undo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        }
        
        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã redo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        function updateHistoryStatus() {
            document.getElementById('historyStatus').textContent = 
                `${historyIndex}/${history.length-1}`;
        }
        
        // Lắng nghe sự kiện thay đổi trên canvas
        canvas.on('object:modified', saveToHistory);
        canvas.on('object:added', saveToHistory);
        canvas.on('object:removed', saveToHistory);

        // ========== CẬP NHẬT TRẠNG THÁI ==========
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
            console.log('Status:', message);
        }

        // ========== ZOOM FUNCTIONS - ĐÃ SỬA ==========
        function updateZoomDisplay() {
            const percent = Math.round(zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomStatus').textContent = percent + '%';
            
            canvas.setZoom(zoomLevel);
            canvas.renderAll();
        }

        function zoomToPoint(point, zoom) {
            const minZoom = MIN_ZOOM;
            const maxZoom = MAX_ZOOM;
            
            if (zoom < minZoom) zoom = minZoom;
            if (zoom > maxZoom) zoom = maxZoom;
            
            zoomLevel = zoom;
            canvas.zoomToPoint(point, zoomLevel);
            updateZoomDisplay();
            updateStatus(`Zoom: ${Math.round(zoomLevel * 100)}%`);
        }

        function zoomIn() {
            const center = canvas.getCenter();
            zoomToPoint(center, zoomLevel + ZOOM_STEP);
        }

        function zoomOut() {
            const center = canvas.getCenter();
            zoomToPoint(center, zoomLevel - ZOOM_STEP);
        }

        function resetZoom() {
            const center = canvas.getCenter();
            zoomToPoint(center, 1);
            updateStatus("Zoom đã reset về 100%");
        }

        // Zoom bằng scroll chuột - zoom vào vị trí chuột
        canvas.on('mouse:wheel', function(opt) {
            opt.e.preventDefault();
            opt.e.stopPropagation();
            
            const delta = opt.e.deltaY;
            const zoom = canvas.getZoom();
            
            // Lấy vị trí chuột tương đối trên canvas
            const pointer = canvas.getPointer(opt.e);
            
            // Tính toán zoom mới
            let newZoom = delta > 0 ? zoom * 0.9 : zoom * 1.1;
            
            // Giới hạn zoom
            if (newZoom < MIN_ZOOM) newZoom = MIN_ZOOM;
            if (newZoom > MAX_ZOOM) newZoom = MAX_ZOOM;
            
            // Zoom vào điểm chuột
            zoomToPoint(pointer, newZoom);
        });

        // Theo dõi vị trí chuột
        canvas.on('mouse:move', function(opt) {
            const pointer = canvas.getPointer(opt.e);
            lastMouseX = pointer.x;
            lastMouseY = pointer.y;
        });

        // Gán sự kiện cho nút zoom
        document.getElementById('zoomInBtn').addEventListener('click', zoomIn);
        document.getElementById('zoomOutBtn').addEventListener('click', zoomOut);
        document.getElementById('zoomResetBtn').addEventListener('click', resetZoom);
        document.getElementById('zoomInCanvas').addEventListener('click', zoomIn);
        document.getElementById('zoomOutCanvas').addEventListener('click', zoomOut);
        document.getElementById('zoomResetCanvas').addEventListener('click', resetZoom);

        // ========== 1. UPLOAD MOCKUP ==========
        document.getElementById('uploadMockupBtn').addEventListener('click', () => {
            document.getElementById('mockupFile').click();
        });

        document.getElementById('mockupFile').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (mockupImage) {
                        canvas.remove(mockupImage);
                    }
                    
                    fabric.Image.fromURL(event.target.result, function(img) {
                        mockupImage = img;
                        mockupImage.selectable = false;
                        mockupImage.evented = false;
                        mockupImage.hasControls = false;
                        mockupImage.hasBorders = false;
                        
                        const scaleX = canvas.width / img.width;
                        const scaleY = canvas.height / img.height;
                        const scale = Math.min(scaleX, scaleY) * 0.9;
                        
                        img.scale(scale);
                        img.set({
                            left: (canvas.width - img.width * scale) / 2,
                            top: (canvas.height - img.height * scale) / 2,
                            originX: 'left',
                            originY: 'top'
                        });
                        
                        canvas.add(img);
                        canvas.sendToBack(img);
                        updateStatus('Mockup đã được tải lên!');
                        saveToHistory();
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // ========== 2. UPLOAD VẬT LIỆU ==========
        document.getElementById('uploadTextureBtn').addEventListener('click', () => {
            document.getElementById('textureFiles').click();
        });

        document.getElementById('textureFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const thumbnailsContainer = document.getElementById('textureThumbnails');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    textures.push({
                        id: Date.now() + index,
                        url: event.target.result,
                        name: file.name,
                        element: null
                    });
                    
                    const thumbnail = document.createElement('img');
                    thumbnail.src = event.target.result;
                    thumbnail.className = 'thumbnail';
                    thumbnail.draggable = true;
                    thumbnail.dataset.index = textures.length - 1;
                    
                    thumbnail.addEventListener('click', function() {
                        document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                        this.classList.add('active');
                        activeTextureIndex = parseInt(this.dataset.index);
                        updateStatus(`Đã chọn: ${textures[activeTextureIndex].name}`);
                    });
                    
                    thumbnail.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('textureIndex', this.dataset.index);
                    });
                    
                    thumbnailsContainer.appendChild(thumbnail);
                    
                    if (index === 0) {
                        thumbnail.click();
                    }
                };
                reader.readAsDataURL(file);
            });
            
            updateStatus(`Đã tải lên ${files.length} ảnh vật liệu`);
        });

        // ========== KÉO THẢ VÀO CANVAS ==========
        canvas.on('drop', function(event) {
            event.e.preventDefault();
            
            const textureIndex = event.e.dataTransfer.getData('textureIndex');
            if (textureIndex === '') return;
            
            const index = parseInt(textureIndex);
            if (textures[index]) {
                const texture = textures[index];
                
                fabric.Image.fromURL(texture.url, function(img) {
                    const maxSize = 200;
                    const scale = maxSize / Math.max(img.width, img.height);
                    
                    img.set({
                        left: event.e.offsetX - (img.width * scale) / 2,
                        top: event.e.offsetY - (img.height * scale) / 2,
                        scaleX: scale,
                        scaleY: scale,
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false
                    });
                    
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    updateStatus(`Đã thêm "${texture.name}" vào mockup`);
                    updateSelectedObject();
                    saveToHistory();
                });
            }
        });

        canvas.on('dragover', function(event) {
            event.e.preventDefault();
        });

        // ========== 3. TRANSFORM (CTRL+T) ==========
        document.getElementById('transformBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                if (activeObj.hasControls) {
                    activeObj.set({
                        hasControls: false,
                        hasBorders: false
                    });
                    this.innerHTML = '<i class="fas fa-expand-alt"></i><span>Transform</span>';
                    saveToHistory();
                } else {
                    activeObj.set({
                        hasControls: true,
                        hasBorders: true
                    });
                    this.innerHTML = '<i class="fas fa-check"></i><span>Áp dụng</span>';
                }
                canvas.renderAll();
                updateStatus('Chế độ Transform: ' + (activeObj.hasControls ? 'Bật' : 'Tắt'));
            } else {
                updateStatus('Vui lòng chọn một đối tượng để transform');
            }
        });

        // ========== 4. FIT THEO BỀ MẶT ==========
        document.getElementById('fitSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                updateStatus('Vui lòng chọn đối tượng cần fit');
                return;
            }
            
            if (!mockupImage) {
                updateStatus('Cần có mockup để fit bề mặt');
                return;
            }
            
            activeObj.set({
                scaleX: activeObj.scaleX * 0.9,
                scaleY: activeObj.scaleY * 0.8,
                skewX: 10,
                skewY: -5,
                opacity: 0.9
            });
            
            activeObj.set({
                left: mockupImage.left + mockupImage.width * mockupImage.scaleX / 2 - activeObj.width * activeObj.scaleX / 2,
                top: mockupImage.top + mockupImage.height * mockupImage.scaleY / 2 - activeObj.height * activeObj.scaleY / 2
            });
            
            canvas.renderAll();
            updateStatus('Đã fit ảnh theo bề mặt mockup');
            saveToHistory();
        });

        // ========== 5. WARP BỀ MẶT - THUẬT TOÁN NÂNG CAO ==========
        document.getElementById('warpSurfaceBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj) {
                updateStatus('Vui lòng chọn đối tượng cần warp');
                return;
            }
            
            if (!mockupImage) {
                updateStatus('Cần có mockup để warp bề mặt');
                return;
            }
            
            updateStatus('Đang áp dụng hiệu ứng warp cho bề mặt cong...');
            
            // Tạo hiệu ứng warp cho bề mặt cong/lồi/lõm
            // Sử dụng fabric.js filters kết hợp với distortion
            const filters = [];
            
            // Thêm hiệu ứng sóng nhẹ cho bề mặt gợn sóng
            filters.push(
                new fabric.Image.filters.Saturation({
                    saturation: 0.1
                }),
                new fabric.Image.filters.Brightness({
                    brightness: 0.05
                })
            );
            
            // Tạo hiệu ứng uốn cong bằng skew và scale không đều
            const warpIntensity = 0.15;
            const randomSkewX = (Math.random() - 0.5) * warpIntensity * 20;
            const randomSkewY = (Math.random() - 0.5) * warpIntensity * 20;
            
            // Áp dụng biến dạng không đều cho hiệu ứng bề mặt 3D
            activeObj.set({
                skewX: activeObj.skewX + randomSkewX,
                skewY: activeObj.skewY + randomSkewY,
                scaleX: activeObj.scaleX * (1 + (Math.random() - 0.5) * warpIntensity),
                scaleY: activeObj.scaleY * (1 + (Math.random() - 0.5) * warpIntensity),
                opacity: 0.85 + Math.random() * 0.1
            });
            
            // Thêm hiệu ứng gradient mask cho các cạnh
            const gradientMask = new fabric.Gradient({
                type: 'linear',
                coords: {
                    x1: 0,
                    y1: 0,
                    x2: activeObj.width,
                    y2: activeObj.height
                },
                colorStops: [
                    { offset: 0, color: 'rgba(255,255,255,0.9)' },
                    { offset: 0.5, color: 'rgba(255,255,255,1)' },
                    { offset: 1, color: 'rgba(255,255,255,0.9)' }
                ]
            });
            
            // Áp dụng bộ lọc và render
            if (filters.length > 0) {
                activeObj.filters = filters;
                activeObj.applyFilters();
            }
            
            // Điều chỉnh vị trí để khớp với mockup
            const mockupCenterX = mockupImage.left + mockupImage.width * mockupImage.scaleX / 2;
            const mockupCenterY = mockupImage.top + mockupImage.height * mockupImage.scaleY / 2;
            
            activeObj.set({
                left: mockupCenterX - activeObj.width * activeObj.scaleX / 2,
                top: mockupCenterY - activeObj.height * activeObj.scaleY / 2
            });
            
            // Thêm hiệu ứng shadow cho chiều sâu
            activeObj.set({
                shadow: new fabric.Shadow({
                    color: 'rgba(0,0,0,0.3)',
                    blur: 10,
                    offsetX: 5,
                    offsetY: 5
                })
            });
            
            canvas.renderAll();
            updateStatus('Đã áp dụng hiệu ứng warp cho bề mặt cong/lồi/lõm');
            saveToHistory();
        });

        // ========== 6. AUTO CÂN MÀU ==========
        document.getElementById('autoColorBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và đối tượng để cân màu');
                return;
            }
            
            updateStatus('Đang cân màu với mockup...');
            
            activeObj.set({
                opacity: 0.85,
                filters: []
            });
            
            activeObj.filters.push(
                new fabric.Image.filters.Brightness({ brightness: 0.05 }),
                new fabric.Image.filters.Contrast({ contrast: 0.1 }),
                new fabric.Image.filters.Saturation({ saturation: -0.05 })
            );
            
            activeObj.applyFilters();
            canvas.renderAll();
            
            updateStatus('Đã cân màu tự động với mockup');
            saveToHistory();
        });

        // ========== CÁC CÔNG CỤ KHÁC ==========
        document.getElementById('removeBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                canvas.remove(activeObj);
                updateStatus('Đã xóa đối tượng');
                updateSelectedObject();
                saveToHistory();
            }
        });

        document.getElementById('bringFrontBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.bringToFront();
                canvas.renderAll();
                updateStatus('Đã đưa lên lớp trên');
                saveToHistory();
            }
        });

        document.getElementById('sendBackBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                activeObj.sendToBack();
                if (mockupImage) {
                    mockupImage.bringToFront();
                }
                canvas.renderAll();
                updateStatus('Đã đưa xuống lớp dưới');
                saveToHistory();
            }
        });

        // ========== UNDO/REDO BUTTONS - MỚI ==========
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);

        // ========== PHÍM TẮT ==========
        document.addEventListener('keydown', function(e) {
            // Transform: Ctrl+T
            if (e.ctrlKey && e.key === 't') {
                e.preventDefault();
                document.getElementById('transformBtn').click();
            }
            
            // Save: Ctrl+S
            if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveBtn').click();
            }
            
            // Undo: Ctrl+Z
            if (e.ctrlKey && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            
            // Redo: Ctrl+Y hoặc Ctrl+Shift+Z
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) {
                e.preventDefault();
                redo();
            }
        });

        // ========== SAVE/EXPORT FUNCTIONALITY ==========
        const saveModal = document.getElementById('saveModal');
        const saveOverlay = document.getElementById('saveOverlay');
        const formatButtons = document.querySelectorAll('.format-btn');
        const qualitySlider = document.getElementById('qualitySlider');
        const qualityValue = document.getElementById('qualityValue');
        const fileNameInput = document.getElementById('fileName');

        // Mở modal save
        document.getElementById('saveBtn').addEventListener('click', function() {
            saveModal.classList.add('active');
            saveOverlay.classList.add('active');
            updateStatus('Chọn định dạng để xuất file');
        });

        // Đóng modal save
        document.getElementById('cancelSave').addEventListener('click', closeSaveModal);
        saveOverlay.addEventListener('click', closeSaveModal);

        function closeSaveModal() {
            saveModal.classList.remove('active');
            saveOverlay.classList.remove('active');
        }

        // Chọn định dạng
        formatButtons.forEach(btn => {
            btn.addEventListener('click', function() {
                formatButtons.forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                currentFormat = this.dataset.format;
                updateStatus(`Đã chọn định dạng: ${currentFormat.toUpperCase()}`);
            });
        });

        // Cập nhật chất lượng
        qualitySlider.addEventListener('input', function() {
            currentQuality = this.value / 100;
            qualityValue.textContent = this.value + '%';
        });

        // Xử lý lưu file
        document.getElementById('confirmSave').addEventListener('click', async function() {
            closeSaveModal();
            updateStatus('Đang xuất file...');
            
            const fileName = fileNameInput.value || 'mockup-k-output';
            const fullFileName = `${fileName}.${currentFormat}`;
            
            try {
                if (currentFormat === 'pdf') {
                    await exportAsPDF(fullFileName);
                } else {
                    await exportAsImage(fullFileName);
                }
                
                updateStatus(`Đã xuất file: ${fullFileName}`);
            } catch (error) {
                console.error('Export error:', error);
                updateStatus('Lỗi khi xuất file: ' + error.message);
            }
        });

        // Xuất ảnh PNG/JPG
        async function exportAsImage(filename) {
            return new Promise((resolve, reject) => {
                // Tạo canvas tạm thời với chất lượng cao
                const tempCanvas = document.createElement('canvas');
                const ctx = tempCanvas.getContext('2d');
                
                // Lấy kích thước thực của canvas
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                
                // Vẽ background trắng nếu cần
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                
                // Vẽ canvas Fabric.js vào canvas tạm
                const dataURL = canvas.toDataURL({
                    format: currentFormat,
                    quality: currentQuality,
                    multiplier: 2 // Độ phân giải cao
                });
                
                const img = new Image();
                img.onload = function() {
                    ctx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                    
                    // Tạo link download
                    const link = document.createElement('a');
                    link.download = filename;
                    link.href = tempCanvas.toDataURL(`image/${currentFormat}`, currentQuality);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    resolve();
                };
                img.onerror = reject;
                img.src = dataURL;
            });
        }

        // Xuất PDF
        async function exportAsPDF(filename) {
            return new Promise((resolve, reject) => {
                try {
                    // Tạo canvas tạm để chuyển đổi
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    
                    const ctx = tempCanvas.getContext('2d');
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                    
                    const dataURL = canvas.toDataURL({
                        format: 'png',
                        quality: 1,
                        multiplier: 1.5
                    });
                    
                    const img = new Image();
                    img.onload = function() {
                        ctx.drawImage(img, 0, 0, tempCanvas.width, tempCanvas.height);
                        
                        // Sử dụng jsPDF
                        const { jsPDF } = window.jspdf;
                        const pdf = new jsPDF({
                            orientation: tempCanvas.width > tempCanvas.height ? 'landscape' : 'portrait',
                            unit: 'px',
                            format: [tempCanvas.width, tempCanvas.height]
                        });
                        
                        pdf.addImage(
                            tempCanvas.toDataURL('image/png'),
                            'PNG',
                            0,
                            0,
                            tempCanvas.width,
                            tempCanvas.height
                        );
                        
                        pdf.save(filename);
                        resolve();
                    };
                    img.onerror = reject;
                    img.src = dataURL;
                } catch (error) {
                    reject(error);
                }
            });
        }

        // ========== THEO DÕI ĐỐI TƯỢNG ĐANG CHỌN ==========
        canvas.on('selection:created', updateSelectedObject);
        canvas.on('selection:updated', updateSelectedObject);
        canvas.on('selection:cleared', updateSelectedObject);

        function updateSelectedObject() {
            const activeObj = canvas.getActiveObject();
            const selectedObjElement = document.getElementById('selectedObj');
            
            if (activeObj && activeObj !== mockupImage) {
                selectedObjElement.textContent = 'Đã chọn';
                selectedObjElement.style.color = '#4ecdc4';
            } else {
                selectedObjElement.textContent = 'Không có';
                selectedObjElement.style.color = '#ff6b6b';
            }
        }

        // ========== KHỞI TẠO ==========
        updateZoomDisplay();
        updateStatus('Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu');
        updateSelectedObject();
        updateHistoryButtons();
        updateHistoryStatus();
        
        // Lưu state ban đầu
        setTimeout(() => {
            saveToHistory();
        }, 100);
    </script>
</body>
</html>
