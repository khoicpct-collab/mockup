<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MOCKUP K - Professional Mockup Editor</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/4.5.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/camanjs/4.1.2/caman.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/glfx.js/0.0.8/fx.js"></script>
    
    <style>
        /* CSS CỦA BẠN (Đã giữ nguyên) */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #2c3e50;
            color: #ecf0f1;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }

        .header {
            background-color: #1c2a35;
            padding: 10px 20px;
            text-align: center;
            border-bottom: 3px solid #4ecdc4;
        }

        .title {
            margin: 0;
            font-size: 1.8em;
            color: #4ecdc4;
            font-weight: 700;
        }

        .subtitle {
            margin: 5px 0 0;
            font-size: 0.9em;
            color: #bdc3c7;
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 320px;
            background-color: #34495e;
            padding: 15px;
            overflow-y: auto;
            border-right: 1px solid #2c3e50;
            box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
        }

        .section {
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px dashed #5e7280;
        }

        .section:last-child {
            border-bottom: none;
        }

        .section-title {
            font-size: 1.1em;
            color: #ecf0f1;
            margin: 0 0 10px 0;
            border-left: 4px solid #4ecdc4;
            padding-left: 8px;
        }

        .upload-btn {
            width: 100%;
            padding: 12px;
            background-color: #4ecdc4;
            color: #2c3e50;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: background-color 0.3s, transform 0.1s;
            margin-bottom: 8px;
        }

        .upload-btn:hover {
            background-color: #3aa59e;
            transform: translateY(-1px);
        }

        .upload-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .upload-btn.secondary:hover {
            background-color: #47627a;
        }
        
        .upload-btn.save {
            background-color: #e74c3c;
            color: white;
        }

        .upload-btn.save:hover {
            background-color: #c0392b;
        }

        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .thumbnail {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #5e7280;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
        }

        .thumbnail:hover, .thumbnail.active {
            border-color: #4ecdc4;
            transform: scale(1.05);
        }

        .tools {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }

        .tool-btn {
            background-color: #3a5369;
            color: #ecf0f1;
            border: none;
            border-radius: 6px;
            padding: 8px 4px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .tool-btn i {
            font-size: 1.2em;
            margin-bottom: 4px;
        }

        .tool-btn:hover {
            background-color: #4ecdc4;
            color: #2c3e50;
        }

        .canvas-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: #2c3e50;
            padding: 15px;
            position: relative;
        }

        .canvas-container {
            flex: 1;
            border: 1px solid #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
            background-color: #1c2a35;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
        }

        #main-canvas {
            display: block;
        }

        .canvas-info {
            display: flex;
            justify-content: space-around;
            padding: 10px 0 0;
            font-size: 0.85em;
            color: #bdc3c7;
        }

        .canvas-info-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        .history-controls, .zoom-controls {
            position: absolute;
            z-index: 10;
        }

        .history-controls {
            top: 10px;
            right: 10px;
        }
        
        .zoom-controls {
            bottom: 10px;
            left: 10px;
            display: flex;
            align-items: center;
            background: rgba(30, 30, 50, 0.8);
            padding: 5px 10px;
            border-radius: 8px;
        }

        .history-btn, .zoom-btn {
            background: rgba(78, 205, 196, 0.1);
            color: #4ecdc4;
            border: 1px solid #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
        }

        .history-btn:hover, .zoom-btn:hover {
            background: #4ecdc4;
            color: #1c2a35;
        }
        
        .zoom-display {
            color: white;
            padding: 0 10px;
            font-weight: bold;
        }

        .status-bar {
            background-color: #1c2a35;
            padding: 5px 15px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            color: #bdc3c7;
            border-top: 1px solid #4ecdc4;
        }

        .status-item {
            display: flex;
            align-items: center;
        }

        .status-item i {
            margin-right: 5px;
            color: #4ecdc4;
        }
        
        /* WARP MODAL & SAVE MODAL */
        .warp-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 30, 50, 0.95);
            padding: 25px;
            border-radius: 15px;
            z-index: 1001;
            width: 550px; 
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(78, 205, 196, 0.5);
            backdrop-filter: blur(10px);
        }

        .warp-modal.active {
            display: block;
        }

        .warp-controls {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .warp-control {
            background: rgba(60, 60, 100, 0.8);
            padding: 15px;
            border-radius: 10px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            color: #4ecdc4;
            font-weight: 600;
        }

        .control-value {
            color: #fff;
            font-weight: bold;
            min-width: 40px;
            text-align: right;
        }

        .warp-slider {
            width: 100%;
            margin: 5px 0;
        }

        .warp-presets {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 15px 0;
        }

        .warp-preset {
            padding: 12px;
            background: rgba(60, 60, 100, 0.8);
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 0.9em;
        }

        .warp-preset:hover {
            background: rgba(78, 205, 196, 0.9);
            transform: translateY(-2px);
        }
        
        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .modal-btn.primary {
            background-color: #4ecdc4;
            color: #2c3e50;
        }

        .modal-btn.primary:hover {
            background-color: #3aa59e;
        }

        .modal-btn.secondary {
            background-color: #3a5369;
            color: #ecf0f1;
        }

        .modal-btn.secondary:hover {
            background-color: #47627a;
        }

        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
        }

        .overlay.active {
            display: block;
        }
        
        /* New Control for Displacement Map */
        .displacement-control {
            grid-column: 1 / span 2;
        }
        
        /* Styling cho input trong modal save */
        #exportFileName {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }
        
        #exportFormat {
            background-color: #2c3e50;
            color: white;
            border: 1px solid #4ecdc4;
        }

    </style>
</head>
<body>
    <div class="header">
        <h1 class="title">MOCKUP K PRO</h1>
        <p class="subtitle">Advanced Mockup Editor with Realistic Texture Warping</p>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3 class="section-title"><i class="fas fa-cloud-upload-alt"></i> 1. Upload Mockup</h3>
                <button class="upload-btn" id="uploadMockupBtn">
                    <i class="fas fa-image"></i> Chọn Ảnh Mockup
                </button>
                <input type="file" id="mockupFile" accept="image/*" hidden>
            </div>
            
            <div class="section">
                <h3 class="section-title" title="Ảnh đen trắng để định hình độ lồi lõm"><i class="fas fa-map"></i> 2. Upload Displacement Map</h3>
                <button class="upload-btn secondary" id="uploadDisplacementBtn">
                    <i class="fas fa-grip-lines"></i> Chọn Displacement Map
                </button>
                <input type="file" id="displacementFile" accept="image/*" hidden>
                <p style="margin-top: 5px; font-size: 0.8em; color: #a9c7c7;">(Ảnh đen trắng, độ tương phản cao)</p>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-layer-group"></i> 3. Upload Vật Liệu</h3>
                <button class="upload-btn secondary" id="uploadTextureBtn">
                    <i class="fas fa-images"></i> Chọn Ảnh Vật Liệu
                </button>
                <input type="file" id="textureFiles" accept="image/*" multiple hidden>
                
                <p style="margin: 15px 0 10px; color: #ccc;">Kéo thả vào canvas:</p>
                <div class="thumbnails" id="textureThumbnails">
                    </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-tools"></i> 4. Công Cụ Chỉnh Sửa</h3>
                <div class="tools">
                    <button class="tool-btn" id="transformBtn" title="Ctrl+T">
                        <i class="fas fa-expand-alt"></i>
                        <span>Transform</span>
                    </button>
                    <button class="tool-btn" id="fitSurfaceBtn">
                        <i class="fas fa-crop-alt"></i>
                        <span>Fit Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="warpSurfaceBtn">
                        <i class="fas fa-wave-square"></i>
                        <span>Warp Bề Mặt</span>
                    </button>
                    <button class="tool-btn" id="perspectiveBtn">
                        <i class="fas fa-cube"></i>
                        <span>Phối Cảnh</span>
                    </button>
                    <button class="tool-btn" id="autoColorBtn">
                        <i class="fas fa-adjust"></i>
                        <span>Cân Màu</span>
                    </button>
                    <button class="tool-btn" id="removeBtn">
                        <i class="fas fa-trash"></i>
                        <span>Xóa</span>
                    </button>
                    <button class="tool-btn" id="bringFrontBtn">
                        <i class="fas fa-arrow-up"></i>
                        <span>Lên Trước</span>
                    </button>
                    <button class="tool-btn" id="sendBackBtn">
                        <i class="fas fa-arrow-down"></i>
                        <span>Ra Sau</span>
                    </button>
                    <button class="tool-btn" id="zoomInBtn" title="Zoom In (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-plus"></i>
                        <span>Zoom In</span>
                    </button>
                    <button class="tool-btn" id="zoomOutBtn" title="Zoom Out (Giữ Ctrl để Pan)">
                        <i class="fas fa-search-minus"></i>
                        <span>Zoom Out</span>
                    </button>
                    <button class="tool-btn" id="zoomResetBtn" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                        <span>Reset Zoom</span>
                    </button>
                </div>
            </div>

            <div class="section">
                <h3 class="section-title"><i class="fas fa-download"></i> 5. Lưu & Xuất File</h3>
                <button class="upload-btn save" id="saveBtn">
                    <i class="fas fa-save"></i> Lưu & Xuất Ảnh
                </button>
                <div style="margin-top: 15px; color: #ccc; font-size: 0.9em;">
                    <i class="fas fa-info-circle"></i> Hỗ trợ: PNG, JPG (Đã sửa lỗi Export)
                </div>
            </div>

        </div>

        <div class="canvas-area">
            <div class="canvas-container">
                <canvas id="main-canvas"></canvas>
                
                <div class="history-controls">
                    <button class="history-btn" id="undoBtn" title="Undo (Ctrl+Z)">
                        <i class="fas fa-undo"></i>
                    </button>
                    <button class="history-btn" id="redoBtn" title="Redo (Ctrl+Y)">
                        <i class="fas fa-redo"></i>
                    </button>
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoomInCanvas" title="Zoom In">
                        <i class="fas fa-search-plus"></i>
                    </button>
                    <div class="zoom-display" id="zoomLevel">100%</div>
                    <button class="zoom-btn" id="zoomOutCanvas" title="Zoom Out">
                        <i class="fas fa-search-minus"></i>
                    </button>
                    <button class="zoom-btn zoom-reset" id="zoomResetCanvas" title="Reset Zoom">
                        <i class="fas fa-expand-arrows-alt"></i>
                    </button>
                </div>
            </div>
            <div class="canvas-info">
                <div class="canvas-info-item">
                    <i class="fas fa-mouse-pointer"></i>
                    <span>Kéo thả ảnh từ sidebar</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-arrows-alt"></i>
                    <span>Giữ **Ctrl** + Kéo chuột để **Pan** (Di chuyển canvas khi zoom)</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-search"></i>
                    <span>Scroll để **Zoom theo chuột**</span>
                </div>
                <div class="canvas-info-item">
                    <i class="fas fa-save"></i>
                    <span>Ctrl+Z/Y để Undo/Redo</span>
                </div>
            </div>
        </div>
    </div>

    <div class="overlay" id="warpOverlay"></div>
    <div class="warp-modal" id="warpModal">
        <h3 class="save-header">
            <i class="fas fa-wave-square"></i> Warp Bề Mặt Nâng Cao
        </h3>
        
        <div class="warp-controls">
             <div class="warp-control displacement-control">
                <div class="control-label">
                    <span>Cường độ Displacement Map</span>
                    <span class="control-value" id="dispIntensityValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="dispIntensitySlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong X (Skew)</span>
                    <span class="control-value" id="warpXValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpXSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Cong Y (Skew)</span>
                    <span class="control-value" id="warpYValue">0</span>
                </div>
                <input type="range" min="-50" max="50" value="0" class="warp-slider" id="warpYSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lồi (Bulge)</span>
                    <span class="control-value" id="bulgeValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="bulgeSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Lõm (Pinch)</span>
                    <span class="control-value" id="pinchValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="pinchSlider">
            </div>
            
             <div class="warp-control">
                <div class="control-label">
                    <span>Gợn Sóng / Xoắn</span>
                    <span class="control-value" id="waveValue">0</span>
                </div>
                <input type="range" min="0" max="100" value="0" class="warp-slider" id="waveSlider">
            </div>
            
            <div class="warp-control">
                <div class="control-label">
                    <span>Độ Hòa Trộn (Blend)</span>
                    <span class="control-value" id="blendValue">50</span>
                </div>
                <input type="range" min="0" max="100" value="50" class="warp-slider" id="blendSlider">
            </div>
        </div>
        
        <div class="warp-presets">
            <button class="warp-preset" data-preset="curve">Bề Mặt Cong</button>
            <button class="warp-preset" data-preset="displacement">Warp Bằng Map</button>
            <button class="warp-preset" data-preset="bulge">Phồng Lên</button>
            <button class="warp-preset" data-preset="pinch">Lõm Xuống</button>
            <button class="warp-preset" data-preset="fold">Nếp Gấp</button>
            <button class="warp-preset" data-preset="reset">Reset</button>
        </div>
        
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelWarp">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="applyWarp">
                <i class="fas fa-check"></i> Áp Dụng
            </button>
        </div>
    </div>

    <div class="overlay" id="saveOverlay"></div>
    <div class="warp-modal" id="saveModal" style="width: 400px; padding: 20px; z-index: 1002;">
        <h3 class="save-header">
            <i class="fas fa-download"></i> Xuất file Mockup
        </h3>
        <div class="warp-controls" style="grid-template-columns: 1fr;">
            <div class="warp-control">
                <div class="control-label">Định dạng file</div>
                <select id="exportFormat" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
                    <option value="png">PNG (Chất lượng cao)</option>
                    <option value="jpeg">JPG (Kích thước nhỏ)</option>
                </select>
            </div>
            <div class="warp-control">
                <div class="control-label">Tên file</div>
                <input type="text" id="exportFileName" value="mockup_k_pro" class="warp-slider" style="height: 40px; border-radius: 6px; padding: 5px;">
            </div>
        </div>
        <div class="modal-buttons">
            <button class="modal-btn secondary" id="cancelSave">
                <i class="fas fa-times"></i> Hủy
            </button>
            <button class="modal-btn primary" id="confirmSave">
                <i class="fas fa-download"></i> Tải xuống
            </button>
        </div>
    </div>


    <div class="status-bar">
        <div class="status-item">
            <i class="fas fa-info-circle"></i>
            <span id="statusText">Sẵn sàng - Kéo thả ảnh để bắt đầu</span>
        </div>
        <div class="status-item">
            <i class="fas fa-object-group"></i>
            <span>Đối tượng: <span id="selectedObj">Không có</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-expand-arrows-alt"></i>
            <span>Zoom: <span id="zoomStatus">100%</span></span>
        </div>
        <div class="status-item">
            <i class="fas fa-history"></i>
            <span>History: <span id="historyStatus">0/0</span></span>
        </div>
    </div>

    <script>
        // ========== KHỞI TẠO CANVAS FABRIC.JS ==========
        const canvas = new fabric.Canvas('main-canvas', {
            backgroundColor: 'transparent',
            preserveObjectStacking: true,
            selection: true,
            selectionKey: 'shiftKey'
        });

        // Tự động điều chỉnh kích thước canvas
        function resizeCanvas() {
            const container = document.querySelector('.canvas-container');
            canvas.setWidth(container.clientWidth);
            canvas.setHeight(container.clientHeight);
            canvas.renderAll();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        // ========== BIẾN TOÀN CỤC ==========
        let mockupImage = null;
        let displacementMap = null; // Biến mới cho Displacement Map
        let textures = [];
        let zoomLevel = 1;
        let isPanning = false; // Biến mới cho Pan
        
        let warpSettings = {
            dispIntensity: 0, // Control mới
            warpX: 0,
            warpY: 0,
            bulge: 0,
            pinch: 0,
            wave: 0,
            blend: 50
        };
        
        // ========== UNDO/REDO SYSTEM ==========
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 50;
        
        function saveToHistory() {
            if (historyIndex < history.length - 1) {
                history = history.slice(0, historyIndex + 1);
            }
            
            const state = canvas.toDatalessJSON(['globalCompositeOperation']);
            history.push(state);
            historyIndex++;
            
            if (history.length > MAX_HISTORY) {
                history.shift();
                historyIndex--;
            }
            
            updateHistoryButtons();
            updateHistoryStatus();
        }
        
        function updateHistoryButtons() {
            const undoBtn = document.getElementById('undoBtn');
            const redoBtn = document.getElementById('redoBtn');
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= history.length - 1;
        }
        
        function updateHistoryStatus() {
            document.getElementById('historyStatus').textContent = 
                `${historyIndex}/${history.length-1}`;
        }
        
        canvas.on('object:modified', saveToHistory);
        canvas.on('object:added', saveToHistory);
        canvas.on('object:removed', saveToHistory);


        // ========== NÂNG CẤP: ZOOM & PAN (Khắc phục lỗi mất hình) ==========
        
        // Bắt sự kiện khi nhấn và nhả chuột trên Canvas (Kích hoạt Pan)
        canvas.on('mouse:down', function(opt) {
            const evt = opt.e;
            // Kích hoạt Pan khi nhấn Ctrl hoặc Alt
            if (evt.ctrlKey || evt.altKey) { 
                isPanning = true;
                canvas.selection = false; // Tắt chọn đối tượng
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.clientY;
            }
        });

        canvas.on('mouse:move', function(opt) {
            if (isPanning && zoomLevel > 1) { // Chỉ Pan khi đã zoom
                const evt = opt.e;
                const vpt = canvas.viewportTransform;
                
                vpt[4] += evt.clientX - canvas.lastPosX;
                vpt[5] += evt.clientY - canvas.lastPosY;
                canvas.requestRenderAll();
                
                canvas.lastPosX = evt.clientX;
                canvas.lastPosY = evt.clientY;
            }
        });

        canvas.on('mouse:up', function(opt) {
            // Tắt Pan và Bật lại chọn đối tượng
            isPanning = false;
            canvas.selection = true; 
        });

        // Bắt sự kiện Scroll Wheel (Zoom theo con trỏ chuột)
        canvas.on('mouse:wheel', function(opt) {
            const delta = opt.e.deltaY;
            let newZoom = zoomLevel;

            if (delta > 0) {
                newZoom /= 1.1; // Zoom Out
            } else if (delta < 0) {
                newZoom *= 1.1; // Zoom In
            }

            // Giới hạn zoom
            newZoom = Math.min(5, Math.max(0.1, newZoom));
            
            // Zoom tại vị trí con trỏ chuột
            canvas.zoomToPoint({ x: opt.e.offsetX, y: opt.e.offsetY }, newZoom);
            zoomLevel = newZoom;
            updateZoomDisplay();
            opt.e.preventDefault(); 
            opt.e.stopPropagation();
        });

        function updateZoomDisplay() {
            const percent = Math.round(zoomLevel * 100);
            document.getElementById('zoomLevel').textContent = percent + '%';
            document.getElementById('zoomStatus').textContent = percent + '%';
            canvas.renderAll();
        }
        
        function zoomToPoint(point, newZoom) {
            zoomLevel = Math.min(5, Math.max(0.1, newZoom));
            canvas.zoomToPoint(point, zoomLevel);
            updateZoomDisplay();
        }
        
        function resetZoom() { 
            // Reset Viewport Transform
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            zoomToPoint(canvas.getCenter(), 1); 
            updateStatus("Zoom đã reset về 100%"); 
        }

        // Event listeners cho các nút Zoom/Reset
        document.getElementById('zoomInCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 1.2));
        document.getElementById('zoomOutCanvas').addEventListener('click', () => zoomToPoint(canvas.getCenter(), zoomLevel * 0.8));
        document.getElementById('zoomResetCanvas').addEventListener('click', resetZoom);


        // ========== UPLOAD FUNCTIONS ==========

        // 1. UPLOAD MOCKUP
        document.getElementById('uploadMockupBtn').addEventListener('click', () => document.getElementById('mockupFile').click());

        document.getElementById('mockupFile').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    if (mockupImage) canvas.remove(mockupImage);
                    
                    fabric.Image.fromURL(event.target.result, function(img) {
                        mockupImage = img;
                        mockupImage.set({ selectable: false, evented: false, hasControls: false, hasBorders: false, name: 'mockup_bg' });
                        
                        const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.9;
                        
                        img.scale(scale);
                        img.set({
                            left: (canvas.width - img.width * scale) / 2,
                            top: (canvas.height - img.height * scale) / 2
                        });
                        
                        canvas.add(img);
                        canvas.sendToBack(img);
                        updateStatus('Mockup đã được tải lên!');
                        saveToHistory();
                    });
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
        
        // 2. UPLOAD DISPLACEMENT MAP
        document.getElementById('uploadDisplacementBtn').addEventListener('click', () => document.getElementById('displacementFile').click());

        document.getElementById('displacementFile').addEventListener('change', function(e) {
            if (e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const img = new Image();
                    img.onload = function() {
                        displacementMap = img;
                        updateStatus('Displacement Map đã được tải lên, sẵn sàng cho Warp!');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });

        // 3. UPLOAD VẬT LIỆU
        document.getElementById('uploadTextureBtn').addEventListener('click', () => document.getElementById('textureFiles').click());

        document.getElementById('textureFiles').addEventListener('change', function(e) {
            const files = Array.from(e.target.files);
            const thumbnailsContainer = document.getElementById('textureThumbnails');
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    textures.push({
                        id: Date.now() + index,
                        url: event.target.result,
                        name: file.name
                    });
                    
                    const thumbnail = document.createElement('img');
                    thumbnail.src = event.target.result;
                    thumbnail.className = 'thumbnail';
                    thumbnail.draggable = true;
                    thumbnail.dataset.index = textures.length - 1;
                    
                    thumbnail.addEventListener('dragstart', function(e) {
                        e.dataTransfer.setData('textureIndex', this.dataset.index);
                    });
                    thumbnailsContainer.appendChild(thumbnail);
                };
                reader.readAsDataURL(file);
            });
            updateStatus(`Đã tải lên ${files.length} ảnh vật liệu`);
        });

        // KÉO THẢ VÀO CANVAS (Áp dụng Blending Mode)
        canvas.on('drop', function(event) {
            event.e.preventDefault();
            
            const textureIndex = event.e.dataTransfer.getData('textureIndex');
            if (textureIndex === '') return;
            
            const index = parseInt(textureIndex);
            if (textures[index]) {
                const texture = textures[index];
                
                fabric.Image.fromURL(texture.url, function(img) {
                    const scale = 200 / Math.max(img.width, img.height);
                    
                    img.set({
                        left: event.e.offsetX - (img.width * scale) / 2,
                        top: event.e.offsetY - (img.height * scale) / 2,
                        scaleX: scale,
                        scaleY: scale,
                        
                        // Áp dụng Blending Mode mặc định cho hòa trộn chân thực
                        globalCompositeOperation: 'multiply', 
                        
                        hasControls: true,
                        hasBorders: true,
                        cornerStyle: 'circle',
                        cornerColor: '#4ecdc4',
                        borderColor: '#4ecdc4',
                        cornerSize: 12,
                        transparentCorners: false,
                        name: 'texture' 
                    });
                    
                    canvas.add(img);
                    canvas.setActiveObject(img);
                    updateStatus(`Đã thêm "${texture.name}" vào mockup`);
                    updateSelectedObject();
                    saveToHistory();
                });
            }
        });

        canvas.on('dragover', function(event) { event.e.preventDefault(); });
        
        // ========== 4. FIT THEO BỀ MẶT NÂNG CAO ==========
        document.getElementById('fitSurfaceBtn').addEventListener('click', function() {
            // (Giữ logic cũ)
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và vật liệu để fit bề mặt');
                return;
            }
            
            const mockupBounds = mockupImage.getBoundingRect();
            const fitScale = 0.8;
            
            const targetWidth = mockupBounds.width * fitScale;
            const targetHeight = mockupBounds.height * fitScale;
            
            const scaleX = targetWidth / activeObj.width;
            const scaleY = targetHeight / activeObj.height;
            const scale = Math.min(scaleX, scaleY);
            
            activeObj.set({
                scaleX: scale,
                scaleY: scale,
                left: mockupBounds.left + (mockupBounds.width - activeObj.width * scale) / 2,
                top: mockupBounds.top + (mockupBounds.height - activeObj.height * scale) / 2,
                angle: 0,
                skewX: 0,
                skewY: 0,
                opacity: 0.9,
                globalCompositeOperation: 'multiply'
            });
            
            activeObj.setCoords();
            canvas.renderAll();
            updateStatus('Đã fit ảnh theo bề mặt mockup');
            saveToHistory();
        });

        // ========== 5. WARP BỀ MẶT - THUẬT TOÁN NÂNG CAO (GLFX.js) ==========
        const warpModal = document.getElementById('warpModal');
        const warpOverlay = document.getElementById('warpOverlay');
        
        document.getElementById('warpSurfaceBtn').addEventListener('click', function() {
            if (!canvas.getActiveObject() || canvas.getActiveObject() === mockupImage) {
                updateStatus('Vui lòng chọn đối tượng cần warp');
                return;
            }
            
            warpModal.classList.add('active');
            warpOverlay.classList.add('active');
            updateStatus('Đang mở công cụ Warp bề mặt');
            
            if (displacementMap) {
                 updateStatus('Displacement Map sẵn sàng. Kéo slider "Cường độ Displacement Map" để biến dạng theo nếp nhăn!');
            } else {
                 updateStatus('Chưa có Displacement Map. Hiệu ứng Warp sẽ chỉ dùng Bulge/Pinch cơ bản.');
            }
        });

        // Logic cập nhật slider (Giữ nguyên)
        const warpSliders = ['dispIntensitySlider', 'warpXSlider', 'warpYSlider', 'bulgeSlider', 'pinchSlider', 'waveSlider', 'blendSlider'];
        const warpValues = ['dispIntensityValue', 'warpXValue', 'warpYValue', 'bulgeValue', 'pinchValue', 'waveValue', 'blendValue'];
        
        warpSliders.forEach((sliderId, index) => {
            const slider = document.getElementById(sliderId);
            const valueDisplay = document.getElementById(warpValues[index]);
            
            slider.addEventListener('input', function() {
                valueDisplay.textContent = this.value;
                const settingKey = sliderId.replace('Slider', '').replace(/([A-Z])/g, match => match.toLowerCase());
                warpSettings[settingKey] = parseInt(this.value);
            });
        });

        // Presets warp (Giữ nguyên)
        document.querySelectorAll('.warp-preset').forEach(btn => {
            btn.addEventListener('click', function() {
                const preset = this.dataset.preset;
                
                switch(preset) {
                    case 'curve':
                        setWarpPreset(0, 20, 15, 30, 0, 0, 60);
                        break;
                    case 'displacement':
                         setWarpPreset(50, 0, 0, 0, 0, 0, 70);
                         break;
                    case 'wave':
                        setWarpPreset(0, 10, 10, 0, 0, 70, 70);
                        break;
                    case 'bulge':
                        setWarpPreset(0, 0, 0, 80, 0, 0, 50);
                        break;
                    case 'pinch':
                        setWarpPreset(0, 0, 0, 0, 70, 0, 50);
                        break;
                    case 'fold':
                        setWarpPreset(0, -25, 30, 40, 20, 50, 80);
                        break;
                    case 'reset':
                        setWarpPreset(0, 0, 0, 0, 0, 0, 50);
                        break;
                }
            });
        });

        function setWarpPreset(dispIntensity, warpX, warpY, bulge, pinch, wave, blend) {
            warpSettings = { dispIntensity, warpX, warpY, bulge, pinch, wave, blend };
            
            document.getElementById('dispIntensitySlider').value = dispIntensity;
            document.getElementById('warpXSlider').value = warpX;
            document.getElementById('warpYSlider').value = warpY;
            document.getElementById('bulgeSlider').value = bulge;
            document.getElementById('pinchSlider').value = pinch;
            document.getElementById('waveSlider').value = wave;
            document.getElementById('blendSlider').value = blend;
            
            document.getElementById('dispIntensityValue').textContent = dispIntensity;
            document.getElementById('warpXValue').textContent = warpX;
            document.getElementById('warpYValue').textContent = warpY;
            document.getElementById('bulgeValue').textContent = bulge;
            document.getElementById('pinchValue').textContent = pinch;
            document.getElementById('waveValue').textContent = wave;
            document.getElementById('blendValue').textContent = blend;
        }

        // Áp dụng warp thực tế (Hàm cốt lõi - Nâng cấp sử dụng Displacement Map)
        function applyWarpToObject(obj) {
            if (!obj || obj.getElement().tagName !== 'IMG') return;
            
            const originalState = obj.toJSON(['globalCompositeOperation']);
            
            const { dispIntensity, warpX, warpY, bulge, pinch, wave, blend } = warpSettings;
            
            const dispFactor = dispIntensity / 100 * 0.15; 
            const bulgeFactor = bulge / 100 * 0.5; 
            const pinchFactor = pinch / 100 * 0.3;
            const waveFactor = wave / 100 * 0.1;
            const blendFactor = blend / 100;
            
            const imgElement = obj.getElement();
            
            try {
                 // 1. Sử dụng GLFX.js cho biến dạng
                const fxCanvas = fx.canvas();
                const texture = fxCanvas.texture(imgElement);
                
                fxCanvas.draw(texture).update();
                
                // Displacement Mapping
                if (dispFactor > 0 && displacementMap) {
                    const displacementTexture = fxCanvas.texture(displacementMap);
                    fxCanvas.heightField(displacementTexture, dispFactor).update();
                }
                
                // Bulge/Pinch
                const center = [0.5, 0.5];
                if (bulgeFactor > 0) {
                    fxCanvas.bulgePinch(center[0], center[1], bulgeFactor, 0.9).update();
                }
                if (pinchFactor > 0) {
                    fxCanvas.bulgePinch(center[0], center[1], -pinchFactor, 0.9).update();
                }
                
                // Swirl/Wave
                if (waveFactor > 0) {
                    fxCanvas.swirl(center[0], center[1], waveFactor * 0.5, 0.5).update();
                }
                
                // 2. Tải lại ảnh đã Warp vào Fabric Object
                const warpedUrl = fxCanvas.toDataURL();
                
                fabric.Image.fromURL(warpedUrl, function(warpedImg) {
                    // Sao chép lại trạng thái transform và vị trí
                    warpedImg.set({
                        ...originalState,
                        left: obj.left,
                        top: obj.top,
                        scaleX: obj.scaleX,
                        scaleY: obj.scaleY,
                        angle: obj.angle,
                        skewX: obj.skewX + warpX * 0.3,
                        skewY: obj.skewY + warpY * 0.3,
                        
                        // Áp dụng Blending Mode và Độ trong suốt
                        globalCompositeOperation: 'soft-light', // Soft-light blend tốt hơn Overlay
                        opacity: Math.max(0.6, 1 - (1 - blendFactor) * 0.4),
                        name: 'texture',
                        
                        // Bóng đổ cho chiều sâu 3D
                        shadow: new fabric.Shadow({
                            color: `rgba(0,0,0,${0.2 + blendFactor * 0.3})`,
                            blur: 10 + bulge * 0.5,
                            offsetX: warpX * 0.1 + dispFactor * 20,
                            offsetY: warpY * 0.1 + dispFactor * 20
                        })
                    });
                    
                    // 3. Thay thế đối tượng cũ bằng đối tượng mới
                    canvas.remove(obj);
                    canvas.add(warpedImg);
                    canvas.setActiveObject(warpedImg);
                    canvas.renderAll();
                    updateStatus('Đã áp dụng hiệu ứng warp/lồi/lõm nâng cao!');
                    saveToHistory();
                });

            } catch (e) {
                updateStatus('Lỗi Warp: Vui lòng kiểm tra console. (Thường do trình duyệt chặn WebGL)');
                console.error('GLFX Warp Error:', e);
            }
        }

        // Áp dụng warp
        document.getElementById('applyWarp').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                applyWarpToObject(activeObj);
                closeWarpModal();
            }
        });

        document.getElementById('cancelWarp').addEventListener('click', closeWarpModal);
        warpOverlay.addEventListener('click', closeWarpModal);

        function closeWarpModal() {
            warpModal.classList.remove('active');
            warpOverlay.classList.remove('active');
        }

        // ========== 7. AUTO CÂN MÀU NÂNG CAO ==========
        document.getElementById('autoColorBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (!activeObj || !mockupImage) {
                updateStatus('Cần có mockup và đối tượng để cân màu');
                return;
            }
            
            updateStatus('Đang phân tích và cân màu nâng cao...');
            
            const avgLuminance = 0.6; // Giá trị tham chiếu
            
            const targetBrightness = (0.5 - avgLuminance) * 0.1; 
            const targetContrast = (avgLuminance - 0.5) * 0.2; 
            
            activeObj.filters = [
                new fabric.Image.filters.Brightness({ brightness: targetBrightness + 0.05 }),
                new fabric.Image.filters.Contrast({ contrast: targetContrast + 0.1 }),
                new fabric.Image.filters.Saturation({ saturation: -0.15 }),
                new fabric.Image.filters.BlendColor({
                    color: '#000000', 
                    mode: 'multiply', 
                    alpha: 0.15
                }),
                new fabric.Image.filters.ColorMatrix({
                    matrix: [
                        1.05, 0, 0, 0, 0,    
                        0, 1.05, 0, 0, 0,    
                        0, 0, 1.05, 0, 0,    
                        0, 0, 0, 1, 0        
                    ]
                })
            ];
            
            activeObj.set({ globalCompositeOperation: 'soft-light' }); 
            
            activeObj.applyFilters();
            canvas.renderAll();
            updateStatus('Đã cân màu nâng cao và áp dụng filter hòa trộn');
            saveToHistory();
        });


        // ========== CHỨC NĂNG LƯU/XUẤT FILE NÂNG CẤP (KHẮC PHỤC LỖI EXPORT) ==========
        const saveModal = document.getElementById('saveModal');
        const saveOverlay = document.getElementById('saveOverlay');
        
        document.getElementById('saveBtn').addEventListener('click', function() {
            saveModal.classList.add('active');
            saveOverlay.classList.add('active');
            updateStatus('Mở hộp thoại xuất file');
        });

        document.getElementById('cancelSave').addEventListener('click', closeSaveModal);
        saveOverlay.addEventListener('click', closeSaveModal);

        function closeSaveModal() {
            saveModal.classList.remove('active');
            saveOverlay.classList.remove('active');
        }

        document.getElementById('confirmSave').addEventListener('click', function() {
            const format = document.getElementById('exportFormat').value;
            const fileName = document.getElementById('exportFileName').value || 'mockup_k_pro';
            
            updateStatus('Đang tạo hình ảnh xuất file, vui lòng chờ...');
            
            // 1. Lưu trạng thái zoom và viewport hiện tại
            const originalVpt = [...canvas.viewportTransform];
            const originalZoom = zoomLevel;
            
            // 2. Tạm thời reset zoom/pan để Canvas.toDataURL chụp toàn bộ
            canvas.setZoom(1);
            canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
            
            // 3. Ẩn Controls và bỏ chọn đối tượng
            canvas.discardActiveObject(); 
            canvas.getObjects().forEach(obj => {
                obj.hasControls = false;
                obj.hasBorders = false;
            });
            canvas.renderAll();

            // 4. Chuyển Canvas sang Data URL (Chụp ảnh)
            const dataURL = canvas.toDataURL({
                format: format,
                quality: 0.95
            });

            // 5. Khôi phục trạng thái Canvas (Asynchronous - dùng setTimeout để đảm bảo)
            setTimeout(() => {
                canvas.setViewportTransform(originalVpt);
                canvas.setZoom(originalZoom);
                zoomLevel = originalZoom;
                updateZoomDisplay();
                
                // Khôi phục Controls cho các đối tượng có thể chọn
                canvas.getObjects().forEach(obj => {
                    if (obj.name === 'texture') {
                        obj.hasControls = true;
                        obj.hasBorders = true;
                    }
                });
                canvas.renderAll();
                
                // 6. Tải file xuống
                const link = document.createElement('a');
                link.href = dataURL;
                link.download = `${fileName}.${format}`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                updateStatus(`Đã xuất file ${fileName}.${format} thành công!`);
                closeSaveModal();

            }, 50); 
        });

        // ========== CÁC CÔNG CỤ KHÁC (Giữ nguyên) ==========
        
        // (Giữ nguyên các hàm: removeBtn, bringFrontBtn, sendBackBtn, undo/redo, transformBtn...)
        document.getElementById('removeBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                canvas.remove(activeObj);
                updateStatus('Đã xóa đối tượng');
                updateSelectedObject();
                saveToHistory();
            }
        });

        document.getElementById('bringFrontBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.bringToFront();
                canvas.renderAll();
                updateStatus('Đã đưa lên lớp trên');
                saveToHistory();
            }
        });

        document.getElementById('sendBackBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj && activeObj !== mockupImage) {
                activeObj.sendToBack();
                if (mockupImage) mockupImage.sendToBack();
                canvas.renderAll();
                updateStatus('Đã đưa xuống lớp dưới');
                saveToHistory();
            }
        });

        document.getElementById('undoBtn').addEventListener('click', function() {
             if (historyIndex > 0) {
                historyIndex--;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã undo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });
        document.getElementById('redoBtn').addEventListener('click', function() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                canvas.loadFromJSON(history[historyIndex], function() {
                    canvas.renderAll();
                    updateSelectedObject();
                    updateStatus(`Đã redo (${historyIndex}/${history.length-1})`);
                    updateHistoryButtons();
                    updateHistoryStatus();
                });
            }
        });

         document.getElementById('transformBtn').addEventListener('click', function() {
            const activeObj = canvas.getActiveObject();
            if (activeObj) {
                activeObj.set({
                    hasControls: !activeObj.hasControls,
                    hasBorders: !activeObj.hasBorders
                });
                canvas.renderAll();
                updateStatus('Chế độ Transform: ' + (activeObj.hasControls ? 'Bật' : 'Tắt'));
                if (!activeObj.hasControls) saveToHistory();
            } else {
                updateStatus('Vui lòng chọn một đối tượng để transform');
            }
        });


        // ========== PHÍM TẮT & THEO DÕI ĐỐI TƯỢNG ==========
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 't') { e.preventDefault(); document.getElementById('transformBtn').click(); }
            if (e.ctrlKey && e.key === 'z') { e.preventDefault(); document.getElementById('undoBtn').click(); }
            if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'Z')) { e.preventDefault(); document.getElementById('redoBtn').click(); }
            if (e.ctrlKey && e.key === 'w') { e.preventDefault(); document.getElementById('warpSurfaceBtn').click(); }
        });

        canvas.on('selection:created', updateSelectedObject);
        canvas.on('selection:updated', updateSelectedObject);
        canvas.on('selection:cleared', updateSelectedObject);

        function updateSelectedObject() {
            const activeObj = canvas.getActiveObject();
            const selectedObjElement = document.getElementById('selectedObj');
            
            if (activeObj && activeObj !== mockupImage) {
                selectedObjElement.textContent = activeObj.name === 'texture' ? 'Vật Liệu' : 'Đã chọn';
                selectedObjElement.style.color = '#4ecdc4';
            } else {
                selectedObjElement.textContent = 'Không có';
                selectedObjElement.style.color = '#ff6b6b';
            }
        }

        // ========== KHỞI TẠO ==========
        updateZoomDisplay();
        updateStatus('Sẵn sàng - Tải mockup và ảnh vật liệu để bắt đầu');
        updateSelectedObject();
        updateHistoryButtons();
        updateHistoryStatus();
        
        setTimeout(() => {
            saveToHistory();
        }, 100);
    </script>
</body>
</html>
